<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>THIS IS US ‚Äî Settings</title>

<style>
:root{
  --bg:#0B1020; --card:#0F1731; --ink:#EAF0FF; --muted:#9FB0D6;
  --stroke:rgba(255,255,255,.12);
  --shadow: 0 28px 90px rgba(0,0,0,.55);
  --glass: rgba(0,0,0,.30);
  --accent:#7c5cff;
  --safeTop: env(safe-area-inset-top);
  --safeBot: env(safe-area-inset-bottom);
}
[data-theme="light"]{
  --bg:#F7F8FB; --card:#FFFFFF; --ink:#0F172A; --muted:#475569;
  --stroke:rgba(2,6,23,.10);
  --shadow: 0 18px 60px rgba(2,6,23,.10);
  --glass: rgba(255,255,255,.78);
}
*{box-sizing:border-box}
body{
  margin:0;
  background:
    radial-gradient(900px 700px at 20% 10%, rgba(124,92,255,.20), transparent 60%),
    var(--bg);
  color:var(--ink);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
.top{
  position:sticky; top:0; z-index:10;
  backdrop-filter: blur(14px);
  background: var(--glass);
  border-bottom:1px solid var(--stroke);
}
.nav{
  max-width:900px; margin:0 auto;
  padding: calc(10px + var(--safeTop)) 16px 10px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.pill{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.06);
  padding:9px 12px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
  color:var(--muted);
  font-weight:900;
}
.wrap{max-width:900px;margin:0 auto;padding:18px 16px 60px;}
.card{
  border:1px solid var(--stroke);
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  border-radius:22px;
  box-shadow: var(--shadow);
  padding:16px;
}
h1{margin:0 0 10px; font-size:22px; letter-spacing:.08em; text-transform:uppercase}
.row{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
.avatar{
  width:84px;height:84px;border-radius:50%;
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.08);
  overflow:hidden;
}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.small{color:var(--muted);font-size:13px}
.btn{
  border:1px solid var(--stroke);
  background: rgba(255,255,255,.08);
  color:var(--ink);
  padding:10px 12px;
  border-radius:14px;
  font-weight:950;
  cursor:pointer;
}
.btn.primary{
  border-color: rgba(124,92,255,.55);
  background: rgba(124,92,255,.16);
}
input[type="file"]{display:block; margin-top:8px}
hr{border:0;border-top:1px solid var(--stroke); margin:14px 0}

/* Terms modal */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: rgba(0,0,0,.60);
  z-index:1000;
  padding:16px;
}
.modal.show{display:flex}
.modalCard{
  width:min(860px, 96vw);
  border:1px solid var(--stroke);
  background: rgba(15,20,40,.96);
  border-radius:22px;
  box-shadow: var(--shadow);
  padding:14px;
}
[data-theme="light"] .modalCard{ background: rgba(255,255,255,.96); }
.modalHead{
  display:flex; align-items:center; justify-content:space-between;
  padding:6px 6px 10px;
}
.modalHead h3{margin:0; font-size:16px; letter-spacing:.04em}
.termsBox{
  border:1px solid var(--stroke);
  border-radius:18px;
  padding:12px;
  background: rgba(255,255,255,.06);
  max-height: 56vh;
  overflow:auto;
}
.note{color:var(--muted); font-size:12px; line-height:1.45}
.checkRow{
  display:flex; gap:10px; align-items:flex-start;
  padding:10px 6px 0;
}
.checkRow input{ width:auto; margin-top:3px; }
</style>
</head>

<body>
  <div class="top">
    <div class="nav">
      <div class="pill" id="backBtn">‚Üê Library</div>
      <div class="pill" id="themeBtn">üåì Theme</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1>Settings</h1>
      <div class="row">
        <div class="avatar" id="avatarBox"></div>
        <div>
          <div style="font-weight:950" id="whoLine">Guest</div>
          <div class="small" id="emailLine">Not signed in</div>
          <div class="small" id="syncLine">Cloud sync: OFF</div>
        </div>
      </div>

      <hr>

      <div style="font-weight:950">Profile photo</div>
      <div class="small">Upload a small image (recommended under ~700KB).</div>
      <input id="photoInput" type="file" accept="image/*">
      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="savePhoto">Save Photo</button>
        <button class="btn" id="clearPhoto">Remove</button>
      </div>

      <hr>

      <div style="font-weight:950">Reading</div>
      <div class="small">Reset progress if you want to restart a book.</div>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="resetBook1">Reset Book1 Progress</button>
      </div>
    </div>
  </div>

  <!-- TERMS MODAL (MANDATORY) -->
  <div class="modal" id="termsModal">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Terms & Conditions</h3>
        <div></div>
      </div>

      <div class="termsBox" id="termsText">
        <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase">THIS IS US ‚Äî Terms</div>
        <p class="note" style="margin-top:10px">Last updated: February 15, 2026</p>

        <p><strong>1) Acceptance</strong><br>
          By accessing or using THIS IS US (the ‚ÄúSite‚Äù), you agree to these Terms. If you do not agree, you may not use the Site.
        </p>

        <p><strong>2) Eligibility</strong><br>
          You represent that you are able to form a legally binding agreement. If you are under the age required in your jurisdiction, use the Site only with a parent/guardian‚Äôs consent.
        </p>

        <p><strong>3) Content & Reader Experience</strong><br>
          The story, chapters, artwork, and design are owned by the Site owner and are protected by copyright. You may read for personal use only. You may not copy, repost, or redistribute the content without written permission.
        </p>

        <p><strong>4) Accounts</strong><br>
          Creating an account is optional. You are responsible for keeping your login credentials secure. The owner may suspend accounts that violate these Terms.
        </p>

        <p><strong>5) User Submissions</strong><br>
          If you post comments or feedback, you agree not to post illegal, harmful, abusive, or infringing content. The owner may remove content at any time.
        </p>

        <p><strong>6) Notifications (Optional)</strong><br>
          If you opt in to email and/or SMS notifications, you consent to receive updates about new chapters or announcements. SMS messages may be subject to carrier rates and fees.
        </p>

        <p><strong>7) Privacy</strong><br>
          The Site may store basic account data (email), reading progress, and (if you opt in) notification contact details.
        </p>

        <p><strong>8) Availability & Changes</strong><br>
          The Site may change, pause, or stop features at any time. Chapters and features may be updated without notice.
        </p>

        <p><strong>9) Disclaimer</strong><br>
          The Site is provided ‚Äúas is‚Äù without warranties of any kind.
        </p>

        <p><strong>10) Limitation of Liability</strong><br>
          To the maximum extent permitted by law, the owner will not be liable for indirect damages arising from your use of the Site.
        </p>

        <p><strong>11) Contact</strong><br>
          For questions or opt-out requests, contact the site owner.
        </p>
      </div>

      <div class="checkRow">
        <input type="checkbox" id="agreeTerms">
        <div class="note">I have read and agree to the Terms & Conditions.</div>
      </div>

      <div style="display:grid; gap:10px; padding-top:10px">
        <button class="btn primary" id="acceptTermsBtn">Accept & Continue</button>
        <div class="note" id="termsMsg"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { firebaseConfig } from "./firebase-config.js";
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, deleteField, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // ‚úÖ shared terms gate
  import { wireTermsGate } from "./terms-gate.js";
  wireTermsGate();

  // Theme
  const savedTheme = localStorage.getItem("theme") || "dark";
  document.documentElement.dataset.theme = savedTheme === "light" ? "light" : "dark";

  document.getElementById("backBtn").onclick = ()=> location.href="./";

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const avatarBox = document.getElementById("avatarBox");
  const whoLine = document.getElementById("whoLine");
  const emailLine = document.getElementById("emailLine");
  const syncLine = document.getElementById("syncLine");

  const photoInput = document.getElementById("photoInput");
  const savePhoto = document.getElementById("savePhoto");
  const clearPhoto = document.getElementById("clearPhoto");

  let UID = null;
  let pendingDataURL = null;

  function setAvatar(url){
    avatarBox.innerHTML = url
      ? `<img src="${url}" alt="Profile">`
      : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:950;">üë§</div>`;
  }

  async function saveUser(obj){
    if(!UID) return;
    try{
      await setDoc(doc(db,"users",UID), { ...obj, updatedAt: serverTimestamp() }, { merge:true });
    }catch{}
  }

  async function loadUser(){
    if(!UID){ setAvatar(""); return; }
    try{
      const snap = await getDoc(doc(db,"users",UID));
      const d = snap.exists() ? snap.data() : {};
      if(d.theme && (d.theme==="dark"||d.theme==="light")){
        document.documentElement.dataset.theme = d.theme;
        localStorage.setItem("theme", d.theme);
      }
      setAvatar(d.photoURL || "");
    }catch{
      setAvatar("");
    }
  }

  document.getElementById("themeBtn").onclick = async ()=>{
    const next = (document.documentElement.dataset.theme === "light") ? "dark" : "light";
    document.documentElement.dataset.theme = next;
    localStorage.setItem("theme", next);
    await saveUser({ theme: next });
  };

  onAuthStateChanged(auth, async (user)=>{
    UID = user ? user.uid : null;
    if(user){
      whoLine.textContent = "Signed in";
      emailLine.textContent = user.email || "User";
      syncLine.textContent = "Cloud sync: ON";
      await loadUser();
    }else{
      whoLine.textContent = "Guest";
      emailLine.textContent = "Not signed in";
      syncLine.textContent = "Cloud sync: OFF";
      setAvatar("");
    }
  });

  photoInput.addEventListener("change", ()=>{
    const file = photoInput.files?.[0];
    if(!file) return;
    if(file.size > 700000){
      alert("Please choose a smaller image (under ~700KB).");
      photoInput.value = "";
      return;
    }
    const reader = new FileReader();
    reader.onload = ()=>{ pendingDataURL = String(reader.result || ""); };
    reader.readAsDataURL(file);
  });

  savePhoto.onclick = async ()=>{
    if(!UID){ alert("Sign in first to save a profile photo."); return; }
    if(!pendingDataURL){ alert("Choose an image first."); return; }
    await saveUser({ photoURL: pendingDataURL });
    pendingDataURL = null;
    await loadUser();
    alert("Saved!");
  };

  clearPhoto.onclick = async ()=>{
    if(!UID){ alert("Sign in first."); return; }
    await setDoc(doc(db,"users",UID), { photoURL: deleteField(), updatedAt: serverTimestamp() }, { merge:true });
    await loadUser();
    alert("Removed!");
  };

  document.getElementById("resetBook1").onclick = async ()=>{
    localStorage.removeItem("progress:book1");
    if(UID){
      try{
        await setDoc(doc(db,"users",UID,"progress","book1"), { index: 0, updatedAt: serverTimestamp() }, { merge:true });
      }catch{}
    }
    alert("Book 1 progress reset.");
  };
</script>
</body>
</html>
