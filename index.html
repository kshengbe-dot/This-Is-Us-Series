<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>THIS IS US ‚Äî Library</title>

  <style><!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>THIS IS US ‚Äî Reader</title>

  <style>
    :root{
      --bg:#0B1020;
      --card:#0F1731;
      --ink:#EAF0FF;
      --muted:#9FB0D6;
      --stroke:rgba(255,255,255,.12);
      --shadow: 0 28px 90px rgba(0,0,0,.55);
      --glow: rgba(124,92,255,.45);
      --accent:#7c5cff;
      --accent2: rgba(0,255,198,.18);
      --glass: rgba(0,0,0,.30);
      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
    }
    [data-theme="light"]{
      --bg:#F7F8FB;
      --card:#FFFFFF;
      --ink:#0F172A;
      --muted:#475569;
      --stroke:rgba(2,6,23,.10);
      --shadow: 0 18px 60px rgba(2,6,23,.10);
      --glow: rgba(124,92,255,.18);
      --accent:#7c5cff;
      --accent2: rgba(2,6,23,.04);
      --glass: rgba(255,255,255,.78);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1100px 800px at 22% 10%, var(--glow), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, var(--accent2), transparent 55%),
        var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}

    /* Top bar */
    .top{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: var(--glass);
      border-bottom:1px solid var(--stroke);
    }
    .nav{
      max-width:1200px; margin:0 auto;
      padding: calc(10px + var(--safeTop)) 16px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      letter-spacing:.14em; text-transform:uppercase;
      font-weight:950;
      min-width:0;
    }
    .brand small{
      color:var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      text-transform:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:46vw;
    }
    .right{
      display:flex;
      align-items:center;
      gap:10px;
      max-width:70vw;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:2px;
    }
    .right::-webkit-scrollbar{height:0}
    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      padding:9px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .15s ease, background .15s ease;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .pill strong{color:var(--ink)}
    .dot{font-size:12px; opacity:.9}

    /* Layout */
    .wrap{max-width:1200px; margin:0 auto; padding:16px 16px calc(90px + var(--safeBot));}
    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      align-items:start;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }

    /* Cards */
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border-radius:22px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    /* Reader shell */
    .readerCard{ padding:14px; }
    .readerHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:6px 6px 10px;
    }
    .titleLine{
      display:flex; flex-direction:column; gap:4px;
      min-width:0;
    }
    .titleLine h1{
      margin:0;
      font-size:16px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 64vw;
    }
    .titleLine .sub{
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      letter-spacing:.04em;
    }
    .controls{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      padding:9px 11px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .15s ease, background .15s ease;
      font-size:12px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn.primary{ border-color: rgba(124,92,255,.55); background: rgba(124,92,255,.16); }

    /* Flipbook */
    .bookStage{
      position:relative;
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      background: rgba(0,0,0,.12);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    [data-theme="light"] .bookStage{ background: rgba(2,6,23,.04); }

    .book{
      position:relative;
      height: clamp(520px, 70vh, 860px);
      perspective: 1400px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:0;
    }
    @media (max-width:760px){
      .book{ grid-template-columns: 1fr; height: clamp(540px, 74vh, 900px); }
    }

    .page{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 400px at 20% 0%, rgba(124,92,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-right:1px solid var(--stroke);
      padding:22px 22px 18px;
    }
    @media (max-width:760px){
      .page{ border-right:none; }
    }

    /* absolutely prevent text overflow / leaks */
    .pageContent{
      height:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right:8px;
      scrollbar-width: none;
    }
    .pageContent::-webkit-scrollbar{ width:0; height:0; }
    .pageContent *{
      max-width:100%;
      word-break: break-word;
      overflow-wrap:anywhere;
    }

    /* book typography */
    .chapter-cover{ text-align:center; padding-top:10px; }
    .chapter-cover h2{
      margin:0;
      font-size:28px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:950;
    }
    .series-sub{ margin:10px 0 0; color:var(--muted); font-weight:800; letter-spacing:.04em; }
    .author{ margin:10px 0 0; color:var(--muted); font-weight:800; }
    .ornament{ border:none; height:1px; background: var(--stroke); margin:18px 0; }
    .chapter-title h3{ margin:0; font-size:16px; letter-spacing:.10em; text-transform:uppercase; color:var(--muted); }
    .chapter-title h4{ margin:8px 0 0; font-size:22px; font-weight:950; }

    p{ margin: 10px 0; line-height:1.75; font-size:15px; }
    .dropcap:first-letter{
      float:left;
      font-size:52px;
      line-height:1;
      padding-right:10px;
      padding-top:4px;
      font-weight:950;
    }

    /* Page footer */
    .pageFoot{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:10px 14px;
      border-top:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.22));
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      font-size:12px;
      color:var(--muted);
    }
    [data-theme="light"] .pageFoot{
      background: linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,.88));
    }

    .progressBar{
      height:10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
      flex:1;
      min-width:120px;
    }
    .progressFill{
      height:100%;
      width:0%;
      background: rgba(124,92,255,.50);
    }

    /* Flip animation overlay */
    .flipLayer{
      pointer-events:none;
      position:absolute;
      inset:0;
      display:none;
    }
    .flipLayer.show{ display:block; }
    .flipHalf{
      position:absolute;
      top:0; bottom:0;
      width:50%;
      background: transparent;
      transform-style: preserve-3d;
    }
    .flipHalf.left{ left:0; transform-origin: right center; }
    .flipHalf.right{ right:0; transform-origin: left center; }
    .flipFace{
      position:absolute; inset:0;
      backface-visibility:hidden;
      border-right:1px solid var(--stroke);
      background:
        radial-gradient(900px 400px at 20% 0%, rgba(124,92,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .flipBack{
      position:absolute; inset:0;
      backface-visibility:hidden;
      transform: rotateY(180deg);
      border-right:1px solid var(--stroke);
      background:
        radial-gradient(900px 400px at 20% 0%, rgba(0,255,198,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }

    /* Side panel */
    .side{ padding:14px; }
    .sideTitle{
      font-weight:950;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--muted);
      font-size:12px;
      margin:4px 0 10px;
    }
    .stat{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.10);
      margin-bottom:10px;
    }
    [data-theme="light"] .stat{ background: rgba(2,6,23,.04); }
    .stat .k{ color:var(--muted); font-size:12px; letter-spacing:.06em; text-transform:uppercase; font-weight:900; }
    .stat .v{ font-weight:950; margin-top:4px; }

    .tip{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    /* Modals */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.60);
      z-index:1000;
      padding:16px;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(900px, 96vw);
      border:1px solid var(--stroke);
      background: rgba(15,20,40,.96);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:14px;
      max-height: 86vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    [data-theme="light"] .modalCard{ background: rgba(255,255,255,.96); }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 6px 10px;
      position:sticky; top:0;
      background: inherit;
      z-index:2;
      border-bottom: 1px solid var(--stroke);
    }
    .modalHead h3{margin:0; font-size:15px; letter-spacing:.06em; text-transform:uppercase}
    .x{
      cursor:pointer; padding:8px 10px; border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      user-select:none;
    }

    /* Community layout */
    .communityGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:10px 6px 6px;
    }
    .formRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:640px){
      .formRow{ grid-template-columns: 1fr; }
    }
    label{
      font-size:12px;color:var(--muted);font-weight:800;
      letter-spacing:.06em;text-transform:uppercase
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius:14px;
      color:var(--ink);
      outline:none;
      font-size:14px;
      font-family: ui-sans-serif, system-ui;
    }
    textarea{ min-height:110px; resize:vertical; }
    .note{ color:var(--muted); font-size:12px; line-height:1.55; }

    /* Bottom mobile hints */
    .swipeHint{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="nav">
      <div class="brand" id="brand">
        THIS IS US
        <small id="brandSub">Reader</small>
      </div>

      <div class="right">
        <div class="pill" id="backBtn">‚Üê <strong>Library</strong></div>
        <div class="pill" id="themeBtn">üåì <strong>Theme</strong></div>
        <div class="pill" id="communityBtn">üí¨ <strong>Community</strong></div>
        <div class="pill" id="authBtn">üîê <strong id="authText">Sign in</strong></div>
        <div class="pill" id="statusPill">
          <span class="dot">‚óè</span>
          <strong id="statusText">Guest</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Reader -->
      <div class="card readerCard">
        <div class="readerHead">
          <div class="titleLine">
            <h1 id="bookTitle">Book</h1>
            <div class="sub" id="bookMeta">Pages ‚Ä¢ Progress</div>
          </div>

          <div class="controls">
            <button class="btn" id="prevBtn">‚Üê Prev</button>
            <button class="btn primary" id="nextBtn">Next ‚Üí</button>
          </div>
        </div>

        <div class="bookStage" id="stage">
          <div class="book" id="book">
            <!-- Left page -->
            <div class="page" id="leftPage">
              <div class="pageContent" id="leftContent"></div>
              <div class="pageFoot">
                <span id="leftNum">‚Äî</span>
                <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
                <span id="pct">0%</span>
              </div>
            </div>

            <!-- Right page -->
            <div class="page" id="rightPage">
              <div class="pageContent" id="rightContent"></div>
              <div class="pageFoot">
                <span id="rightNum">‚Äî</span>
                <span id="syncLine">Local</span>
              </div>
            </div>

            <!-- Flip overlay -->
            <div class="flipLayer" id="flipLayer" aria-hidden="true">
              <div class="flipHalf right" id="flipRight">
                <div class="flipFace"></div>
                <div class="flipBack"></div>
              </div>
              <div class="flipHalf left" id="flipLeft">
                <div class="flipFace"></div>
                <div class="flipBack"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="swipeHint">
          <span>Desktop: use buttons / arrow keys</span>
          <span>Mobile: swipe left/right</span>
        </div>
      </div>

      <!-- Side panel -->
      <div class="card side">
        <div class="sideTitle">Stats</div>
        <div class="stat">
          <div class="k">Readers</div>
          <div class="v"><span id="readerCount">‚Äî</span> Total</div>
        </div>
        <div class="stat">
          <div class="k">Rating</div>
          <div class="v" id="ratingSummary">‚Äî</div>
        </div>
        <div class="stat">
          <div class="k">Your progress</div>
          <div class="v"><span id="progressText">‚Äî</span></div>
        </div>
        <div class="tip" id="tipBox">
          Tip: Sign in to sync your progress across devices and react to comments.
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal">
    <div class="modalCard" style="width:min(560px, 96vw);">
      <div class="modalHead">
        <h3>Account</h3>
        <div class="x" id="authClose">‚úï</div>
      </div>

      <div class="communityGrid">
        <div class="formRow">
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="Email">
          </div>
          <div>
            <label>Password</label>
            <input id="password" type="password" placeholder="Password">
          </div>
        </div>

        <div class="formRow">
          <button class="btn primary" id="loginBtn">Sign In</button>
          <button class="btn" id="signupBtn">Create Account</button>
        </div>

        <button class="btn" id="logoutBtn" style="display:none;">Sign Out</button>

        <div class="note">
          Reading works without login. Sign in only if you want cloud sync + reactions + ratings + achievements.
        </div>
      </div>
    </div>
  </div>

  <!-- COMMUNITY MODAL -->
  <div class="modal" id="communityModal">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Community</h3>
        <div class="x" id="communityClose">‚úï</div>
      </div>

      <div class="communityGrid">
        <div class="card" style="box-shadow:none; border-radius:18px; padding:12px;">
          <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase;color:var(--muted);font-size:12px">Rate this book</div>
          <div class="formRow" style="margin-top:10px">
            <div>
              <label>Your rating</label>
              <select id="myRating">
                <option value="0">Select‚Ä¶</option>
                <option value="1">1 ‚òÖ</option>
                <option value="2">2 ‚òÖ‚òÖ</option>
                <option value="3">3 ‚òÖ‚òÖ‚òÖ</option>
                <option value="4">4 ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                <option value="5">5 ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
              </select>
            </div>
            <div style="display:flex;align-items:end;gap:10px">
              <button class="btn primary" id="rateBtn">Submit</button>
              <div class="note" id="rateMsg"></div>
            </div>
          </div>
        </div>

        <div class="card" style="box-shadow:none; border-radius:18px; padding:12px;">
          <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase;color:var(--muted);font-size:12px">Leave a comment</div>

          <form id="commentForm" style="margin-top:10px">
            <div class="formRow">
              <div>
                <label>Name</label>
                <input id="cName" placeholder="Your name (optional)">
              </div>
              <div>
                <label>Stars (optional)</label>
                <select id="cRating">
                  <option value="0">None</option>
                  <option value="1">1 ‚òÖ</option>
                  <option value="2">2 ‚òÖ‚òÖ</option>
                  <option value="3">3 ‚òÖ‚òÖ‚òÖ</option>
                  <option value="4">4 ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                  <option value="5">5 ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Comment</label>
              <textarea id="cText" placeholder="Share your thoughts‚Ä¶"></textarea>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px">
              <button class="btn primary" type="submit">Post</button>
              <div class="note" id="cMsg"></div>
            </div>
          </form>
        </div>

        <div class="card" style="box-shadow:none; border-radius:18px; padding:12px;">
          <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase;color:var(--muted);font-size:12px">Comments</div>
          <div id="commentsList" style="margin-top:10px"></div>
        </div>

        <div class="card" style="box-shadow:none; border-radius:18px; padding:12px;">
          <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase;color:var(--muted);font-size:12px">Your achievements</div>
          <div id="achList" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOOK CONTENT (IN-PAGE so it never breaks/overlaps) -->
  <template id="book1Content">
    <section class="chapter-cover">
      <h2>THIS IS US</h2>
      <p class="series-sub">Book I ‚Äî <em>Where We Began</em></p>
      <p class="author">by Shengbe Koker</p>
    </section>

    <hr class="ornament"/>

    <section class="chapter-title">
      <h3>Chapter One</h3>
      <h4>Fresh Starts</h4>
    </section>

    <p class="dropcap">Mukeh did not believe in fresh starts.</p>
    <p>He believed in survival.</p>
    <p>When he transferred at the beginning of the academic year, people treated it like opportunity ‚Äî a clean slate, a reset button, a chance to become someone new.</p>
    <p>But walking through the school gates that first morning didn‚Äôt feel new.</p>
    <p>It felt heavy.</p>
    <p>The courtyard was already alive ‚Äî voices layered over each other, laughter breaking easily between groups who had known each other for years. Students leaned against walls with the comfort of familiarity. Others crossed the grounds like they belonged to every inch of it.</p>
    <p>Mukeh adjusted the strap of his bag and walked forward.</p>

    <!-- Add more paragraphs here. The reader will auto-split into pages. -->
  </template>

  <script type="module">
    import { firebaseConfig } from "./firebase-config.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    import {
      bumpReaderCountOnce,
      renderReaderCount
    } from "./public-feed.js";

    import {
      renderComments,
      setupCommentForm,
      submitRating,
      loadMyRating,
      renderRatingSummary,
      renderMyAchievements,
      trackAchievements,
      guidelinesHTML
    } from "./reader-community.js";

    // =========================
    // Utilities
    // =========================
    function qs(k){ return new URLSearchParams(location.search).get(k); }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    // =========================
    // Theme
    // =========================
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.dataset.theme = savedTheme === "light" ? "light" : "dark";

    // =========================
    // Firebase
    // =========================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // Book selection
    // =========================
    const bookId = qs("book") || "book1";
    const brandSub = document.getElementById("brandSub");
    const bookTitle = document.getElementById("bookTitle");
    const bookMeta = document.getElementById("bookMeta");
    const syncLine = document.getElementById("syncLine");
    const progressText = document.getElementById("progressText");

    const BOOKS = {
      book1: {
        title: "Book I ‚Äî Where We Began",
        templateId: "book1Content"
      },
      coming: {
        title: "Coming Soon",
        templateId: null
      }
    };

    const bookInfo = BOOKS[bookId] || BOOKS.book1;
    brandSub.textContent = bookInfo.title;
    bookTitle.textContent = bookInfo.title;

    // =========================
    // Navigation buttons
    // =========================
    document.getElementById("backBtn").onclick = ()=> location.href = "index.html";
    document.getElementById("themeBtn").onclick = async ()=>{
      const next = (document.documentElement.dataset.theme === "light") ? "dark" : "light";
      document.documentElement.dataset.theme = next;
      localStorage.setItem("theme", next);
      if(window.__UID){
        try{
          await setDoc(doc(db,"users",window.__UID), { theme: next, updatedAt: serverTimestamp() }, { merge:true });
        }catch{}
      }
    };

    // =========================
    // AUTH modal
    // =========================
    const authModal = document.getElementById("authModal");
    const authBtn  = document.getElementById("authBtn");
    const authText = document.getElementById("authText");
    const authClose = document.getElementById("authClose");

    function openAuthModal(){ authModal.classList.add("show"); document.body.style.overflow="hidden"; }
    function closeAuthModal(){ authModal.classList.remove("show"); document.body.style.overflow=""; }

    authBtn.onclick = openAuthModal;
    authClose.onclick = closeAuthModal;
    authModal.addEventListener("click",(e)=>{ if(e.target === authModal) closeAuthModal(); });

    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    // =========================
    // COMMUNITY modal
    // =========================
    const communityModal = document.getElementById("communityModal");
    const communityBtn = document.getElementById("communityBtn");
    const communityClose = document.getElementById("communityClose");

    function openCommunity(){
      communityModal.classList.add("show");
      document.body.style.overflow="hidden";
      // render community content every open (fresh counts, new comments, etc.)
      renderComments({ bookId, mountId:"commentsList", max: 40 });
      renderRatingSummary({ bookId, mountId:"ratingSummary" });
      renderMyAchievements({ bookId, mountId:"achList" });

      // jump to comment if deep link exists
      const targetId = qs("comment");
      if(targetId){
        setTimeout(()=>{
          const el = document.getElementById("comment-" + targetId);
          if(el) el.scrollIntoView({ behavior:"smooth", block:"start" });
        }, 450);
      }
    }
    function closeCommunity(){
      communityModal.classList.remove("show");
      document.body.style.overflow="";
    }

    communityBtn.onclick = openCommunity;
    communityClose.onclick = closeCommunity;
    communityModal.addEventListener("click",(e)=>{ if(e.target === communityModal) closeCommunity(); });

    // auto-open if URL says open=community
    if(qs("open") === "community"){
      setTimeout(()=> openCommunity(), 300);
    }

    // =========================
    // Auth state + sync hints
    // =========================
    const statusText = document.getElementById("statusText");
    const tipBox = document.getElementById("tipBox");

    async function loadUserThemeAndApply(uid){
      try{
        const snap = await getDoc(doc(db,"users",uid));
        const d = snap.exists() ? (snap.data() || {}) : {};
        if(d.theme && (d.theme==="dark" || d.theme==="light")){
          document.documentElement.dataset.theme = d.theme;
          localStorage.setItem("theme", d.theme);
        }
      }catch{}
    }

    onAuthStateChanged(auth, async (user)=>{
      window.__UID = user ? user.uid : null;

      if(user){
        statusText.textContent = "Synced";
        authText.textContent = "Account";
        logoutBtn.style.display = "inline-flex";
        syncLine.textContent = "Cloud sync";
        tipBox.textContent = "Cloud sync is ON. Reactions, ratings, achievements enabled.";

        await setDoc(doc(db,"users",user.uid), {
          email: user.email || "",
          updatedAt: serverTimestamp()
        }, { merge:true });

        await loadUserThemeAndApply(user.uid);

        // load my rating into selector
        try{
          const mine = await loadMyRating({ bookId });
          document.getElementById("myRating").value = String(mine || 0);
        }catch{}
      }else{
        statusText.textContent = "Guest";
        authText.textContent = "Sign in";
        logoutBtn.style.display = "none";
        syncLine.textContent = "Local";
        tipBox.textContent = "Tip: Sign in to sync your progress across devices and react to comments.";

        document.getElementById("myRating").value = "0";
      }
    });

    loginBtn.onclick = async ()=>{
      try{
        await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
        closeAuthModal();
      }catch(e){ alert(e.message); }
    };
    signupBtn.onclick = async ()=>{
      try{
        const cred = await createUserWithEmailAndPassword(auth, email.value.trim(), password.value);
        await setDoc(doc(db, "users", cred.user.uid), {
          email: email.value.trim(),
          createdAt: serverTimestamp(),
          theme: localStorage.getItem("theme") || "dark"
        }, { merge:true });
        closeAuthModal();
      }catch(e){ alert(e.message); }
    };
    logoutBtn.onclick = async ()=>{
      await signOut(auth);
      closeAuthModal();
    };

    // =========================
    // Rating submit
    // =========================
    const rateBtn = document.getElementById("rateBtn");
    const rateMsg = document.getElementById("rateMsg");
    rateBtn.onclick = async ()=>{
      rateMsg.textContent = "";
      const val = Number(document.getElementById("myRating").value || 0);
      try{
        await submitRating({ bookId, rating: val });
        rateMsg.textContent = "Saved ‚úÖ";
        renderRatingSummary({ bookId, mountId:"ratingSummary" });
      }catch(e){
        rateMsg.textContent = e?.message || "Could not rate.";
      }
    };

    // =========================
    // Comment form setup
    // =========================
    setupCommentForm({
      bookId,
      formId:"commentForm",
      nameId:"cName",
      textId:"cText",
      ratingId:"cRating",
      msgId:"cMsg",
      afterPostReload:true
    });

    // =========================
    // Reader counts
    // =========================
    renderReaderCount({ bookId, mountId:"readerCount" });
    // bump reader count once per device per day
    const bumpKey = `bump:${bookId}:${new Date().toISOString().slice(0,10)}`;
    if(!localStorage.getItem(bumpKey)){
      localStorage.setItem(bumpKey, "1");
      bumpReaderCountOnce({ bookId, uid: window.__UID || null }).catch(()=>{});
    }

    // =========================
    // Book content -> pages
    // (NO missing words: we paginate based on measured height)
    // =========================
    const leftContent = document.getElementById("leftContent");
    const rightContent = document.getElementById("rightContent");
    const leftNum = document.getElementById("leftNum");
    const rightNum = document.getElementById("rightNum");
    const progressFill = document.getElementById("progressFill");
    const pctEl = document.getElementById("pct");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const flipLayer = document.getElementById("flipLayer");
    const flipLeft = document.getElementById("flipLeft");
    const flipRight = document.getElementById("flipRight");

    let PAGES = []; // html strings
    let idx = 0;    // left page index (0-based)
    let isFlipping = false;

    function getLocalProgressKey(){ return `progress:${bookId}`; }
    function loadLocalProgress(){
      try{
        const v = JSON.parse(localStorage.getItem(getLocalProgressKey()) || "{}");
        return Number(v.leftIndex || 0);
      }catch{ return 0; }
    }
    function saveLocalProgress(leftIndex){
      localStorage.setItem(getLocalProgressKey(), JSON.stringify({
        leftIndex,
        updatedAt: Date.now()
      }));
    }

    async function saveCloudProgress(leftIndex){
      if(!window.__UID) return;
      try{
        await setDoc(doc(db,"users",window.__UID,"progress",bookId), {
          leftIndex,
          updatedAt: serverTimestamp()
        }, { merge:true });
      }catch{}
    }

    async function loadCloudProgress(){
      if(!window.__UID) return null;
      try{
        const snap = await getDoc(doc(db,"users",window.__UID,"progress",bookId));
        const d = snap.exists() ? (snap.data() || {}) : {};
        const v = Number(d.leftIndex ?? NaN);
        if(Number.isFinite(v)) return v;
        return null;
      }catch{ return null; }
    }

    function setProgressUI(){
      const total = Math.max(1, PAGES.length);
      const current = clamp(idx, 0, total-1);
      const rightIndex = current + 1;

      leftNum.textContent = `${current+1} / ${total}`;
      rightNum.textContent = rightIndex < total ? `${rightIndex+1} / ${total}` : `‚Äî`;
      const percent = Math.floor(((current+1)/total) * 100);
      pctEl.textContent = `${percent}%`;
      progressFill.style.width = `${percent}%`;
      progressText.textContent = `${percent}% ‚Ä¢ page ${current+1}`;

      bookMeta.textContent = `${total} pages ‚Ä¢ ${percent}%`;
    }

    function render(){
      if(PAGES.length === 0){
        leftContent.innerHTML = `<div style="color:var(--muted);font-weight:900">No pages yet.</div>`;
        rightContent.innerHTML = "";
        setProgressUI();
        return;
      }
      idx = clamp(idx, 0, PAGES.length-1);
      const rightIndex = idx + 1;

      leftContent.innerHTML = PAGES[idx] || "";
      rightContent.innerHTML = (rightIndex < PAGES.length) ? (PAGES[rightIndex] || "") : `<div style="opacity:.75;color:var(--muted);font-weight:900">End of available pages.</div>`;

      setProgressUI();
      saveLocalProgress(idx);
      saveCloudProgress(idx);

      // achievements tracking (pageIndex = idx)
      trackAchievements({ bookId, pageIndex: idx, totalPages: PAGES.length }).catch(()=>{});
    }

    // Flip animation (simple, reliable)
    function doFlip(dir){
      if(isFlipping) return;
      isFlipping = true;

      flipLayer.classList.add("show");
      flipLeft.style.transform = "none";
      flipRight.style.transform = "none";

      // choose which half rotates depending on direction
      const target = dir === "next" ? flipRight : flipLeft;
      const deg = dir === "next" ? -180 : 180;

      target.style.transition = "transform .38s ease";
      target.style.transform = `rotateY(${deg}deg)`;

      setTimeout(()=>{
        target.style.transition = "";
        target.style.transform = "none";
        flipLayer.classList.remove("show");
        isFlipping = false;
      }, 410);
    }

    function next(){
      if(idx + 2 < PAGES.length){
        doFlip("next");
        idx += 2;
        render();
      }else if(idx + 1 < PAGES.length){
        // allow one last step
        doFlip("next");
        idx += 1;
        render();
      }
    }
    function prev(){
      if(idx - 2 >= 0){
        doFlip("prev");
        idx -= 2;
        render();
      }else if(idx - 1 >= 0){
        doFlip("prev");
        idx -= 1;
        render();
      }
    }

    nextBtn.onclick = next;
    prevBtn.onclick = prev;

    // keyboard
    window.addEventListener("keydown",(e)=>{
      if(e.key === "ArrowRight") next();
      if(e.key === "ArrowLeft") prev();
      if(e.key === "Escape"){
        if(communityModal.classList.contains("show")) closeCommunity();
        if(authModal.classList.contains("show")) closeAuthModal();
      }
    });

    // swipe (mobile)
    const stage = document.getElementById("stage");
    let touchX = 0, touchY = 0;
    stage.addEventListener("touchstart",(e)=>{
      const t = e.touches?.[0];
      if(!t) return;
      touchX = t.clientX;
      touchY = t.clientY;
    }, { passive:true });

    stage.addEventListener("touchend",(e)=>{
      const t = e.changedTouches?.[0];
      if(!t) return;
      const dx = t.clientX - touchX;
      const dy = t.clientY - touchY;
      if(Math.abs(dx) < 40) return;
      if(Math.abs(dy) > Math.abs(dx)) return; // ignore vertical scroll
      if(dx < 0) next();
      else prev();
    }, { passive:true });

    // =========================
    // Pagination engine
    // =========================
    function getBookHTML(){
      if(bookId === "coming"){
        return `
          <section class="chapter-cover">
            <h2>COMING SOON</h2>
            <p class="series-sub">This book is loading‚Ä¶</p>
            <p class="author">Check back for updates.</p>
          </section>
          <hr class="ornament"/>
          <p class="dropcap">You‚Äôre early.</p>
          <p>The next part of THIS IS US is being built right now.</p>
          <p>Return to the library and subscribe for updates.</p>
        `;
      }
      const tpl = document.getElementById(bookInfo.templateId);
      return tpl ? tpl.innerHTML.trim() : `<p class="dropcap">Missing content.</p>`;
    }

    function buildPagesFromHTML(html){
      // create a hidden measurer using the same page width
      const meas = document.createElement("div");
      meas.style.cssText = `
        position:fixed; left:-9999px; top:0;
        width:${leftContent.clientWidth}px;
        height:${leftContent.clientHeight}px;
        overflow:auto;
        padding-right:8px;
        color:var(--ink);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      `;
      // match your inside page padding context
      // (we measure content only, not page container)
      document.body.appendChild(meas);

      // split by paragraphs/blocks but preserve formatting
      const tmp = document.createElement("div");
      tmp.innerHTML = html;

      const blocks = Array.from(tmp.childNodes).filter(n=>{
        if(n.nodeType === 3) return n.textContent.trim().length; // text node
        if(n.nodeType === 1) return true; // element
        return false;
      });

      const pages = [];
      let cur = document.createElement("div");
      meas.innerHTML = "";
      meas.appendChild(cur);

      function pushPage(){
        pages.push(cur.innerHTML.trim() || `<div style="opacity:.75;color:var(--muted);font-weight:900">‚Ä¶</div>`);
        cur = document.createElement("div");
        meas.innerHTML = "";
        meas.appendChild(cur);
      }

      for(const b of blocks){
        const clone = (b.nodeType === 3)
          ? document.createTextNode(b.textContent)
          : b.cloneNode(true);

        cur.appendChild(clone);

        // if overflow, rollback and create new page
        if(meas.scrollHeight > meas.clientHeight + 2){
          cur.removeChild(clone);

          // if single block too big, force it alone (still scrolls inside page)
          if(cur.childNodes.length === 0){
            cur.appendChild(clone);
            pushPage();
            continue;
          }

          pushPage();
          cur.appendChild(clone);

          // if still overflow, keep it alone
          if(meas.scrollHeight > meas.clientHeight + 2){
            pushPage();
          }
        }
      }

      if(cur.childNodes.length) pushPage();
      document.body.removeChild(meas);
      return pages;
    }

    function repaginate(){
      const html = getBookHTML();
      PAGES = buildPagesFromHTML(html);

      // load progress: cloud (if signed in) else local
      idx = loadLocalProgress();
      idx = clamp(idx, 0, Math.max(0, PAGES.length-1));
      // keep left index even when possible (nice spread)
      if(idx % 2 === 1 && idx > 0) idx -= 1;

      render();
    }

    // repaginate after first paint (sizes correct)
    setTimeout(repaginate, 80);

    // repaginate on resize (debounced)
    let rz = null;
    window.addEventListener("resize", ()=>{
      clearTimeout(rz);
      rz = setTimeout(()=> repaginate(), 220);
    });

    // if user signs in later, try to load cloud progress once and apply if ahead
    let cloudApplied = false;
    onAuthStateChanged(auth, async (user)=>{
      if(!user || cloudApplied) return;
      cloudApplied = true;
      const v = await loadCloudProgress();
      if(v == null) return;

      const local = loadLocalProgress();
      // choose the furthest progress
      let chosen = Math.max(Number(local||0), Number(v||0));
      chosen = clamp(chosen, 0, Math.max(0, PAGES.length-1));
      if(chosen % 2 === 1 && chosen > 0) chosen -= 1;
      idx = chosen;
      render();
    });

    // preload rating summary + comments only when community opens
    // but keep side rating updated
    renderRatingSummary({ bookId, mountId:"ratingSummary" });

  </script>
</body>
</html>

    :root{
      --bg:#0B1020;
      --card:#0F1731;
      --ink:#EAF0FF;
      --muted:#9FB0D6;
      --stroke:rgba(255,255,255,.12);
      --shadow: 0 28px 90px rgba(0,0,0,.55);
      --glow: rgba(124,92,255,.45);
      --accent:#7c5cff;
      --accent2: rgba(0,255,198,.18);
      --glass: rgba(0,0,0,.30);
      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
    }
    [data-theme="light"]{
      --bg:#F7F8FB;
      --card:#FFFFFF;
      --ink:#0F172A;
      --muted:#475569;
      --stroke:rgba(2,6,23,.10);
      --shadow: 0 18px 60px rgba(2,6,23,.10);
      --glow: rgba(124,92,255,.18);
      --accent:#7c5cff;
      --accent2: rgba(2,6,23,.04);
      --glass: rgba(255,255,255,.78);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1100px 800px at 22% 10%, var(--glow), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, var(--accent2), transparent 55%),
        var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    a{color:inherit;text-decoration:none}

    .top{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: var(--glass);
      border-bottom:1px solid var(--stroke);
    }
    .nav{
      max-width:1100px; margin:0 auto;
      padding: calc(10px + var(--safeTop)) 16px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      letter-spacing:.14em; text-transform:uppercase;
      font-weight:950;
      min-width:0;
    }
    .brand small{
      color:var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      text-transform:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:46vw;
    }
    .right{
      display:flex;
      align-items:center;
      gap:10px;
      max-width:66vw;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:2px;
    }
    .right::-webkit-scrollbar{height:0}

    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      padding:9px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .15s ease, background .15s ease;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .pill strong{color:var(--ink)}
    .dot{font-size:12px; opacity:.9}

    .wrap{max-width:1100px; margin:0 auto; padding:18px 16px 70px;}
    .hero{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      margin-top:16px;
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border-radius:22px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .heroMain{ padding:18px 18px 16px; min-height: 260px; }
    .heroMain:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(700px 320px at 25% 0%, rgba(124,92,255,.22), transparent 65%),
        radial-gradient(520px 320px at 90% 20%, rgba(0,255,198,.10), transparent 65%);
      pointer-events:none;
    }
    h1{
      margin:0 0 10px;
      font-size:44px;
      line-height:1.02;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:950;
      position:relative;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.55;
      max-width:65ch;
      position:relative;
    }
    .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; position:relative}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .15s ease, background .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn.primary{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.16);
    }
    .heroSide{ padding:16px; min-height:260px; display:grid; gap:10px; }
    .stat{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.10);
    }
    [data-theme="light"] .stat{background: rgba(2,6,23,.04)}
    .stat .k{color:var(--muted); font-size:12px; letter-spacing:.06em; text-transform:uppercase}
    .stat .v{font-weight:950; font-size:16px; margin-top:4px}

    .sectionTitle{
      margin:26px 0 12px;
      display:flex; align-items:end; justify-content:space-between; gap:12px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:18px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .shelf{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:14px;
    }
    .bookCard{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transform-style:preserve-3d;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
      cursor:pointer;
      min-height: 340px;
      animation: pop .45s ease both;
    }
    @keyframes pop{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
    .bookCard:hover{
      transform: translateY(-4px) rotateX(3deg) rotateY(-4deg);
      border-color: rgba(124,92,255,.35);
      background: linear-gradient(180deg, rgba(124,92,255,.12), rgba(255,255,255,.02));
    }
    .cover{
      height: 230px;
      background: rgba(0,0,0,.18);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .cover img{
      width:100%; height:100%;
      object-fit:cover;
      transform: scale(1.02);
      transition: transform .22s ease;
      display:block;
    }
    .bookCard:hover .cover img{ transform: scale(1.06); }
    .meta{ padding:12px 12px 14px; }
    .meta .name{ font-weight:950; margin:0; font-size:16px; }
    .meta .desc{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.45; }

    .badge{
      position:absolute; top:12px; left:12px;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:950;
      letter-spacing:.06em;
      text-transform:uppercase;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .badge.live{ border-color: rgba(0,255,198,.35); }
    .badge.soon{ border-color: rgba(255,198,0,.35); }

    .lockedOverlay{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.42));
      display:flex; align-items:center; justify-content:center;
      opacity:0; transition: opacity .18s ease;
    }
    .bookCard.locked:hover .lockedOverlay{ opacity:1; }
    .lockedOverlay .inner{
      border:1px solid var(--stroke);
      background: rgba(15,20,40,.80);
      padding:12px 14px;
      border-radius:16px;
      text-align:center;
      max-width: 220px;
    }
    .lockedOverlay .inner p{margin:6px 0 0; color:var(--muted); font-size:12px}

    /* Modals */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.60);
      z-index:1000;
      padding:16px;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(860px, 96vw);
      border:1px solid var(--stroke);
      background: rgba(15,20,40,.96);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:14px;

      /* ‚úÖ mobile scroll fix */
      max-height: 86vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    [data-theme="light"] .modalCard{ background: rgba(255,255,255,.96); }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 6px 10px;
      position:sticky; top:0;
      background: inherit;
      z-index:2;
    }
    .modalHead h3{margin:0; font-size:16px; letter-spacing:.04em}
    .x{
      cursor:pointer; padding:8px 10px; border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .grid{ display:grid; gap:10px; padding:6px; }
    label{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.06em;text-transform:uppercase}
    input{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius:14px;
      color:var(--ink);
      outline:none;
      font-size:14px;
    }
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .note{color:var(--muted); font-size:12px; line-height:1.45}
    .mini{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:space-between;
      margin-top:14px; position:relative;
    }
    .avatar{
      width:44px; height:44px; border-radius:50%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      overflow:hidden;
      flex:none;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .profileLine{display:flex; align-items:center; gap:10px;}
    .who{font-weight:950}
    .small{color:var(--muted); font-size:12px}

    .termsBox{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background: rgba(255,255,255,.06);
      max-height: 56vh;
      overflow:auto;
    }
    .checkRow{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 6px 0;
    }
    .checkRow input{ width:auto; margin-top:3px; }

    /* ‚úÖ Comment Preview (Carousel) */
    .previewWrap{ margin-top:16px; }
    .previewTitle{
      margin:26px 0 12px;
      display:flex; align-items:end; justify-content:space-between; gap:12px;
    }
    .previewTitle h2{
      margin:0;
      font-size:18px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
    }

    /* ‚úÖ Background blend fix: use the same "card" tone (not a weird new color) */
    .previewShell{
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow: var(--shadow);
      background:
        radial-gradient(700px 220px at 25% 0%, rgba(124,92,255,.14), transparent 65%),
        radial-gradient(520px 220px at 90% 20%, rgba(0,255,198,.08), transparent 65%),
        rgba(255,255,255,.04);
      overflow:hidden;
      position:relative;
    }
    [data-theme="light"] .previewShell{
      background:
        radial-gradient(700px 220px at 25% 0%, rgba(124,92,255,.10), transparent 65%),
        radial-gradient(520px 220px at 90% 20%, rgba(2,6,23,.06), transparent 65%),
        rgba(2,6,23,.02);
    }

    .previewInner{
      padding:14px;
      min-height: 128px;
      position:relative;
    }

    /* These classes are used by renderCommentPreviewCarousel() */
    .previewSlide{
      position:absolute;
      inset:14px;
      opacity:0;
      transform: translateY(6px);
      transition: opacity .65s ease, transform .65s ease;
      pointer-events:none;
      cursor:pointer;
    }
    .previewSlide.show{
      opacity:1;
      transform:none;
      pointer-events:auto;
    }

    .pHint{
      padding:10px 14px 12px;
      border-top:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    @media (max-width:980px){
      .hero{grid-template-columns:1fr}
      .shelf{grid-template-columns: repeat(2, minmax(0, 1fr));}
      h1{font-size:38px}
    }
    @media (max-width:520px){
      .shelf{grid-template-columns:1fr}
      h1{font-size:34px}
      .right{max-width:72vw;}
      .row2{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="nav">
      <div class="brand">
        THIS IS US
        <small>Series Library</small>
      </div>
      <div class="right">
        <div class="pill" id="themeBtn">üåì <strong>Theme</strong></div>

        <!-- ‚úÖ Announcement button removed (announcements are auto shown / auto disappear) -->

        <div class="pill" id="openSubBtn">üîî <strong>Subscribe</strong></div>
        <div class="pill" id="settingsBtn">‚öôÔ∏è <strong>Settings</strong></div>
        <div class="pill" id="authBtn">üîê <strong id="authText">Sign in</strong></div>
        <div class="pill" id="statusPill">
          <span class="dot">‚óè</span>
          <strong id="statusText">Guest</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
      <div class="card heroMain">
        <h1>THIS IS US</h1>
        <p class="subtitle">
          A premium novel-reader: filled pages, smooth flip animation, saved progress, light/dark mode,
          and optional Firebase sync so your pages follow you across devices.
        </p>
        <div class="ctaRow">
          <a class="btn primary" href="read.html?book=book1">‚ñ∂ Start Book I</a>
          <a class="btn" href="read.html?book=coming">üëÄ Coming Soon Preview</a>
          <button class="btn" id="openAuth">‚ú® Sign in to Sync</button>
        </div>

        <div class="mini">
          <div class="profileLine">
            <div class="avatar" id="avatarBox"></div>
            <div>
              <div class="who" id="whoLine">Guest Reader</div>
              <div class="small" id="emailLine">Progress saved locally</div>
            </div>
          </div>
          <div class="small" id="syncHint">Sign in to save to cloud</div>
        </div>
      </div>

      <div class="card heroSide">
        <div class="stat"><div class="k">Readers</div><div class="v"><span id="readerCount">‚Äî</span> Total</div></div>
        <div class="stat"><div class="k">Subscribers</div><div class="v"><span id="subCount">‚Äî</span> Total</div></div>
        <div class="stat"><div class="k">Theme</div><div class="v">Light / Dark</div></div>
      </div>
    </div>

    <!-- ‚úÖ ALWAYS VISIBLE ANNOUNCEMENTS SECTION (AUTO, EXPIRES, NO BUTTON NEEDED) -->
    <div id="announceBanner"></div>

    <!-- ‚úÖ Animated Comment Preview Carousel -->
    <div class="previewWrap">
      <div class="previewTitle">
        <h2>What readers are saying</h2>
        <div class="pill" style="cursor:default;">Auto preview</div>
      </div>

      <div class="previewShell">
        <div class="previewInner" id="commentPreview">Loading‚Ä¶</div>
        <div class="pHint">
          <span>Tap a preview to jump to that comment.</span>
          <span style="opacity:.9">Opens Community inside Reader</span>
        </div>
      </div>
    </div>

    <div class="sectionTitle">
      <h2>Library</h2>
      <div class="pill">Tap a book ‚Üí Read</div>
    </div>

    <div class="shelf">
      <a class="bookCard" href="read.html?book=book1" aria-label="Book 1">
        <div class="badge live">Live</div>
        <div class="cover">
          <img src="assets/cover-book1.png" alt="Book 1 Cover" onerror="this.style.display='none'">
        </div>
        <div class="meta">
          <p class="name">Book I ‚Äî Where We Began</p>
          <p class="desc">Mukeh arrives. Francess is the standard. Awareness begins.</p>
        </div>
      </a>

      <a class="bookCard locked" href="read.html?book=coming" aria-label="Coming Soon Book 2">
        <div class="badge soon">Coming Soon</div>
        <div class="cover">
          <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:950;letter-spacing:.14em;text-transform:uppercase;">
            Next Book
          </div>
        </div>
        <div class="meta">
          <p class="name">Book II ‚Äî Coming Soon</p>
          <p class="desc">A new season is loading. New pressure. New cost. New choices.</p>
        </div>
        <div class="lockedOverlay">
          <div class="inner">
            <strong>Preview</strong>
            <p>Tap to open the Coming Soon page.</p>
          </div>
        </div>
      </a>

      <a class="bookCard locked" href="read.html?book=coming" aria-label="Coming Soon Book 3">
        <div class="badge soon">Coming Soon</div>
        <div class="cover">
          <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:950;letter-spacing:.14em;text-transform:uppercase;">
            Next Book
          </div>
        </div>
        <div class="meta">
          <p class="name">Book III ‚Äî Coming Soon</p>
          <p class="desc">Some friendships become fault lines. Some love becomes a mirror.</p>
        </div>
        <div class="lockedOverlay">
          <div class="inner">
            <strong>Preview</strong>
            <p>Tap to open the Coming Soon page.</p>
          </div>
        </div>
      </a>

      <a class="bookCard locked" href="read.html?book=coming" aria-label="Coming Soon Book 4">
        <div class="badge soon">Coming Soon</div>
        <div class="cover">
          <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:950;letter-spacing:.14em;text-transform:uppercase;">
            Next Book
          </div>
        </div>
        <div class="meta">
          <p class="name">Book IV ‚Äî Coming Soon</p>
          <p class="desc">The past returns. The narrative changes. The costs rise.</p>
        </div>
        <div class="lockedOverlay">
          <div class="inner">
            <strong>Preview</strong>
            <p>Tap to open the Coming Soon page.</p>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="modal">
    <div class="modalCard" style="width:min(560px, 96vw);">
      <div class="modalHead">
        <h3>Account</h3>
        <div class="x" id="close">‚úï</div>
      </div>

      <div class="grid">
        <div class="row2">
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="Email">
          </div>
          <div>
            <label>Password</label>
            <input id="password" type="password" placeholder="Password">
          </div>
        </div>

        <div class="row2">
          <button class="btn primary" id="loginBtn">Sign In</button>
          <button class="btn" id="signupBtn">Create Account</button>
        </div>

        <button class="btn" id="logoutBtn" style="display:none;">Sign Out</button>

        <p class="note">
          Reading works without login. Sign in only if you want cloud sync across devices.
        </p>
      </div>
    </div>
  </div>

  <!-- SUBSCRIBE MODAL -->
  <div class="modal" id="newsModal">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Subscribe</h3>
        <div class="x" id="newsClose">‚úï</div>
      </div>

      <div class="grid">
        <div style="font-weight:950; letter-spacing:.12em; text-transform:uppercase; color:var(--muted)">Subscribe</div>

        <form id="subscribeForm" class="grid">
          <div class="row2">
            <input id="subEmail" type="email" placeholder="Email (required if Email is checked)">
            <input id="subPhone" type="tel" placeholder="Phone (required if SMS is checked)">
          </div>

          <div class="row2">
            <label style="display:flex;gap:10px;align-items:center;text-transform:none;letter-spacing:0;font-weight:900;color:var(--ink)">
              <input type="checkbox" id="optEmail"> Email notifications
            </label>
            <label style="display:flex;gap:10px;align-items:center;text-transform:none;letter-spacing:0;font-weight:900;color:var(--ink)">
              <input type="checkbox" id="optSMS"> SMS notifications
            </label>
          </div>

          <button class="btn primary" type="submit">Subscribe</button>
          <div class="note" style="margin-top:-2px">
            SMS may be subject to carrier rates. You can opt out anytime by contacting the site owner.
          </div>
          <div class="note" id="subMsg"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- TERMS MODAL (MANDATORY) -->
  <div class="modal" id="termsModal">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Terms & Conditions</h3>
        <div></div>
      </div>

      <div class="termsBox" id="termsText">
        <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase">THIS IS US ‚Äî Terms</div>
        <p class="note" style="margin-top:10px">
          Last updated: February 15, 2026
        </p>

        <p><strong>1) Acceptance</strong><br>
          By accessing or using THIS IS US (the ‚ÄúSite‚Äù), you agree to these Terms. If you do not agree, you may not use the Site.
        </p>

        <p><strong>2) Eligibility</strong><br>
          You represent that you are able to form a legally binding agreement. If you are under the age required in your jurisdiction, use the Site only with a parent/guardian‚Äôs consent.
        </p>

        <p><strong>3) Content & Reader Experience</strong><br>
          The story, chapters, artwork, and design are owned by the Site owner and are protected by copyright. You may read for personal use only. You may not copy, repost, or redistribute the content without written permission.
        </p>

        <p><strong>4) Accounts</strong><br>
          Creating an account is optional. You are responsible for keeping your login credentials secure. The owner may suspend accounts that violate these Terms.
        </p>

        <p><strong>5) User Submissions</strong><br>
          If you post comments or feedback, you agree not to post illegal, harmful, abusive, or infringing content. The owner may remove content at any time.
        </p>

        <p><strong>6) Notifications (Optional)</strong><br>
          If you opt in to email and/or SMS notifications, you consent to receive updates about new chapters or announcements. SMS messages may be subject to carrier rates and fees. You can opt out by updating your preferences or contacting the owner.
        </p>

        <p><strong>7) Privacy</strong><br>
          The Site may store basic account data (email), reading progress, and (if you opt in) notification contact details. Subscriber lists are private and visible only to the owner/admin.
        </p>

        <p><strong>8) Availability & Changes</strong><br>
          The Site may change, pause, or stop features at any time. Chapters and features may be updated without notice.
        </p>

        <p><strong>9) Disclaimer</strong><br>
          The Site is provided ‚Äúas is‚Äù without warranties of any kind. The owner does not guarantee uninterrupted access or that the Site will be error-free.
        </p>

        <p><strong>10) Limitation of Liability</strong><br>
          To the maximum extent permitted by law, the owner will not be liable for indirect, incidental, special, or consequential damages arising from your use of the Site.
        </p>

        <p><strong>11) Contact</strong><br>
          For questions, removal requests, or opt-out requests, contact the site owner.
        </p>
      </div>

      <div class="checkRow">
        <input type="checkbox" id="agreeTerms">
        <div class="note">
          I have read and agree to the Terms & Conditions.
        </div>
      </div>

      <div class="grid" style="padding-top:10px">
        <button class="btn primary" id="acceptTermsBtn">Accept & Continue</button>
        <div class="note" id="termsMsg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from "./firebase-config.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    import {
      renderAnnouncementSection,
      setupSubscribeForm,
      renderReaderCount,
      renderSubscriberCount
    } from "./public-feed.js";

    import { renderCommentPreviewCarousel } from "./reader-community.js";
    import { wireTermsGate } from "./terms-gate.js";

    // Theme (local first)
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.dataset.theme = savedTheme === "light" ? "light" : "dark";

    // Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    document.getElementById("themeBtn").onclick = async ()=>{
      const next = (document.documentElement.dataset.theme === "light") ? "dark" : "light";
      document.documentElement.dataset.theme = next;
      localStorage.setItem("theme", next);
      if(window.__UID){
        try{
          await setDoc(doc(db,"users",window.__UID), { theme: next, updatedAt: serverTimestamp() }, { merge:true });
        }catch{}
      }
    };

    document.getElementById("settingsBtn").onclick = ()=> location.href = "settings.html";

    // ===== AUTH MODAL =====
    const modal = document.getElementById("modal");
    const openAuth = document.getElementById("openAuth");
    const authBtn  = document.getElementById("authBtn");
    const close = document.getElementById("close");
    function openModal(){ modal.classList.add("show"); document.body.style.overflow="hidden"; }
    function closeModal(){ modal.classList.remove("show"); document.body.style.overflow=""; }
    openAuth.onclick = openModal;
    authBtn.onclick  = openModal;
    close.onclick = closeModal;
    modal.addEventListener("click",(e)=>{ if(e.target === modal) closeModal(); });

    // ===== SUBSCRIBE MODAL =====
    const newsModal = document.getElementById("newsModal");
    const newsClose = document.getElementById("newsClose");
    document.getElementById("openSubBtn").onclick = ()=>{
      newsModal.classList.add("show");
      document.body.style.overflow="hidden";
    };
    newsClose.onclick = ()=>{ newsModal.classList.remove("show"); document.body.style.overflow=""; };
    newsModal.addEventListener("click",(e)=>{ if(e.target === newsModal){ newsModal.classList.remove("show"); document.body.style.overflow=""; } });

    // Subscribe form
    setupSubscribeForm({ bookId:"book1" });

    // ===== PROFILE UI =====
    const statusText = document.getElementById("statusText");
    const authText = document.getElementById("authText");
    const whoLine = document.getElementById("whoLine");
    const emailLine = document.getElementById("emailLine");
    const syncHint = document.getElementById("syncHint");
    const avatarBox = document.getElementById("avatarBox");

    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function setAvatar(url){
      avatarBox.innerHTML = url
        ? `<img src="${url}" alt="Profile">`
        : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:950;">üë§</div>`;
    }

    async function loadProfile(uid){
      try{
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        const data = snap.exists() ? snap.data() : {};
        if(data.theme && (data.theme==="dark" || data.theme==="light")){
          document.documentElement.dataset.theme = data.theme;
          localStorage.setItem("theme", data.theme);
        }
        setAvatar(data.photoURL || "");
      }catch{
        setAvatar("");
      }
    }

    // ‚úÖ TERMS GATE
    wireTermsGate();

    // ===== AUTH STATE =====
    onAuthStateChanged(auth, async (user)=>{
      window.__UID = user ? user.uid : null;

      if(user){
        statusText.textContent = "Synced";
        authText.textContent = "Account";
        logoutBtn.style.display = "inline-flex";
        whoLine.textContent = "Signed in";
        emailLine.textContent = user.email || "User";
        syncHint.textContent = "Cloud sync is ON";

        await setDoc(doc(db, "users", user.uid), {
          email: user.email || "",
          updatedAt: serverTimestamp()
        }, { merge:true });

        await loadProfile(user.uid);
      }else{
        statusText.textContent = "Guest";
        authText.textContent = "Sign in";
        logoutBtn.style.display = "none";
        whoLine.textContent = "Guest Reader";
        emailLine.textContent = "Progress saved locally";
        syncHint.textContent = "Sign in to save to cloud";
        setAvatar("");
      }
    });

    loginBtn.onclick = async ()=>{
      try{
        await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
        closeModal();
      }catch(e){ alert(e.message); }
    };

    signupBtn.onclick = async ()=>{
      try{
        const cred = await createUserWithEmailAndPassword(auth, email.value.trim(), password.value);
        await setDoc(doc(db, "users", cred.user.uid), {
          email: email.value.trim(),
          createdAt: serverTimestamp(),
          theme: localStorage.getItem("theme") || "dark"
        }, { merge:true });
        closeModal();
      }catch(e){ alert(e.message); }
    };

    logoutBtn.onclick = async ()=>{
      await signOut(auth);
      closeModal();
    };

    // ‚úÖ PUBLIC FEEDS (auto)
    renderAnnouncementSection({ mountId:"announceBanner", max: 10 });

    // ‚úÖ COUNTS
    renderReaderCount({ bookId:"book1", mountId:"readerCount" });
    renderSubscriberCount({ bookId:"book1", mountId:"subCount" });

    // ‚úÖ COMMENT PREVIEW CAROUSEL (animated + deep link)
    renderCommentPreviewCarousel({
      mountId:"commentPreview",
      max: 8,
      intervalMs: 4200
    });
  </script>
</body>
</html>
