<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>THE KOKER ‚Äî Archives</title>
  <meta name="description" content="The Koker Archives ‚Äî premium novel reader library with sync, community, ratings, and achievements." />

  <style>
    :root{
      --bg:#0B1020; --card:#0F1731; --ink:#EAF0FF; --muted:#9FB0D6;
      --stroke:rgba(255,255,255,.12);
      --shadow: 0 28px 90px rgba(0,0,0,.55);
      --glow: rgba(124,92,255,.45);
      --accent:#7c5cff;
      --accent2: rgba(0,255,198,.18);
      --glass: rgba(0,0,0,.30);
      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
    }
    [data-theme="light"]{
      --bg:#F7F8FB; --card:#FFFFFF; --ink:#0F172A; --muted:#475569;
      --stroke:rgba(2,6,23,.10);
      --shadow: 0 18px 60px rgba(2,6,23,.10);
      --glow: rgba(124,92,255,.18);
      --accent:#7c5cff;
      --accent2: rgba(2,6,23,.04);
      --glass: rgba(255,255,255,.78);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(1100px 800px at 22% 10%, var(--glow), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, var(--accent2), transparent 55%),
        var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    a{color:inherit;text-decoration:none}

    .top{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: var(--glass);
      border-bottom:1px solid var(--stroke);
    }
    .nav{
      max-width:1100px; margin:0 auto;
      padding: calc(10px + var(--safeTop)) 16px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      letter-spacing:.14em; text-transform:uppercase;
      font-weight:950; min-width:0;
    }
    .brand small{
      color:var(--muted); font-weight:800;
      letter-spacing:.08em; text-transform:none;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:46vw;
    }
    .right{
      display:flex; align-items:center; gap:10px;
      max-width:66vw; overflow:auto; -webkit-overflow-scrolling: touch;
      padding-bottom:2px;
    }
    .right::-webkit-scrollbar{height:0}
    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      padding:9px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .15s ease, background .15s ease;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .pill strong{color:var(--ink)}
    .dot{font-size:12px; opacity:.9}

    .wrap{max-width:1100px; margin:0 auto; padding:18px 16px 70px;}
    .hero{
      display:grid; grid-template-columns: 1.25fr .75fr;
      gap:16px; margin-top:16px;
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border-radius:22px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .heroMain{ padding:18px 18px 16px; min-height: 260px; }
    .heroMain:before{
      content:""; position:absolute; inset:-1px;
      background:
        radial-gradient(700px 320px at 25% 0%, rgba(124,92,255,.22), transparent 65%),
        radial-gradient(520px 320px at 90% 20%, rgba(0,255,198,.10), transparent 65%);
      pointer-events:none;
    }
    h1{
      margin:0 0 10px;
      font-size:44px;
      line-height:1.02;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:950;
      position:relative;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:14px;
      line-height:1.55;
      max-width:65ch;
      position:relative;
    }
    .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; position:relative}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .15s ease, background .15s ease;
      user-select:none;
      font-family: ui-sans-serif, system-ui;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn.primary{ border-color: rgba(124,92,255,.55); background: rgba(124,92,255,.16); }

    .heroSide{ padding:16px; min-height:260px; display:grid; gap:10px; }
    .stat{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.10);
    }
    [data-theme="light"] .stat{background: rgba(2,6,23,.04)}
    .stat .k{color:var(--muted); font-size:12px; letter-spacing:.06em; text-transform:uppercase}
    .stat .v{font-weight:950; font-size:16px; margin-top:4px}
    .mini{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:space-between; margin-top:10px; }
    .avatar{
      width:44px; height:44px; border-radius:50%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      overflow:hidden;
      flex:none;
      display:flex; align-items:center; justify-content:center;
      font-weight:950; color:var(--muted);
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .who{font-weight:950}
    .small{color:var(--muted); font-size:12px}

    .sectionTitle{
      margin:26px 0 12px;
      display:flex;
      align-items:end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .sectionTitle h2{
      margin:0;
      font-size:18px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .searchRow{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin: 10px 0 14px;
    }
    .search{
      flex:1;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-weight:800;
      min-width: 220px;
    }

    .favStrip{
      display:none;
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      margin-bottom: 14px;
    }
    .favStrip.show{ display:block; }
    .favHead{
      padding:12px 14px;
      border-bottom: 1px solid var(--stroke);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .favRow{
      display:flex; gap:12px;
      padding:12px 14px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .favRow::-webkit-scrollbar{height:0}
    .miniCard{
      flex:0 0 auto;
      width: 180px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(255,255,255,.05);
      overflow:hidden;
      cursor:pointer;
      transition: transform .15s ease;
    }
    .miniCard:hover{ transform: translateY(-2px); }
    .miniCover{ height: 110px; border-bottom:1px solid var(--stroke); background: rgba(0,0,0,.12); }
    .miniCover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .miniMeta{ padding:10px; }
    .miniName{ font-weight:950; font-size:12px; line-height:1.2; }
    .miniSub{ color:var(--muted); font-size:11px; margin-top:4px; line-height:1.35; }

    .tabRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .tabBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font: 950 12px ui-sans-serif,system-ui;
      letter-spacing:.04em;
      user-select:none;
    }
    .tabBtn.active{
      color: var(--ink);
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.16);
    }

    .tabShell{
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow: var(--shadow);
      background:
        radial-gradient(700px 220px at 25% 0%, rgba(124,92,255,.14), transparent 65%),
        radial-gradient(520px 220px at 90% 20%, rgba(0,255,198,.08), transparent 65%),
        rgba(255,255,255,.04);
      overflow:hidden;
      position:relative;
    }
    [data-theme="light"] .tabShell{
      background:
        radial-gradient(700px 220px at 25% 0%, rgba(124,92,255,.10), transparent 65%),
        radial-gradient(520px 220px at 90% 20%, rgba(2,6,23,.06), transparent 65%),
        rgba(2,6,23,.02);
    }
    .tabInner{ padding:14px; min-height: 130px; position:relative; }
    .tabPanel{ display:none; }
    .tabPanel.show{ display:block; }

    .pHint{
      padding:10px 14px 12px;
      border-top:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* ===========================
       ‚úÖ Comment Preview Carousel
       =========================== */
    .cWrap{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(0,0,0,.10);
      overflow:hidden;
      position:relative;
    }
    [data-theme="light"] .cWrap{background: rgba(2,6,23,.04)}
    .cViewport{
      overflow:hidden;
      position:relative;
      touch-action: pan-y;
    }
    .cTrack{
      display:flex;
      will-change: transform;
      transition: transform .45s ease;
    }
    .cSlide{
      flex: 0 0 100%;
      padding:12px;
    }
    .cCard{
      border:1px solid var(--stroke);
      border-radius:16px;
      background: rgba(255,255,255,.04);
      padding:12px;
    }
    .cTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .cName{ font-weight:950; }
    .cMeta{ color:var(--muted); font-size:12px; white-space:nowrap; }
    .cText{ opacity:.92; line-height:1.6; font-size:13px; }
    .cActions{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .cNav{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
    }
    .cNavLeft{ display:flex; gap:8px; align-items:center; }
    .cIconBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:950;
      user-select:none;
    }
    .cDots{ display:flex; gap:6px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .cDot{
      width:7px; height:7px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      opacity:.65;
    }
    .cDot.on{
      opacity:1;
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.25);
    }

    .shelf{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:14px; }
    .bookCard{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      transform-style:preserve-3d;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
      cursor:pointer;
      min-height: 320px;
      animation: pop .45s ease both;
    }
    @keyframes pop{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none} }
    .bookCard:hover{
      transform: translateY(-4px) rotateX(3deg) rotateY(-4deg);
      border-color: rgba(124,92,255,.35);
      background: linear-gradient(180deg, rgba(124,92,255,.12), rgba(255,255,255,.02));
    }
    .cover{
      height: 210px;
      background: rgba(0,0,0,.18);
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      transform: scale(1.02);
      transition: transform .22s ease;
      display:block;
    }
    .bookCard:hover .cover img{ transform: scale(1.06); }
    .meta{ padding:12px 12px 14px; }
    .meta .name{ font-weight:950; margin:0; font-size:15px; line-height:1.2; }
    .meta .desc{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.45; }

    .badge{
      position:absolute; top:12px; left:12px;
      padding:7px 10px; border-radius:999px;
      font-size:12px; font-weight:950;
      letter-spacing:.06em; text-transform:uppercase;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .badge.live{ border-color: rgba(0,255,198,.35); }
    .badge.soon{ border-color: rgba(255,198,0,.35); }
    .badge.new{
      left:auto; right:12px;
      border-color: rgba(255,130,130,.35);
      background: rgba(255,100,100,.10);
    }

    .favBtn{
      position:absolute; bottom:12px; right:12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      border-radius: 999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:950;
      display:flex; align-items:center; gap:6px;
      backdrop-filter: blur(10px);
    }
    [data-theme="light"] .favBtn{ background: rgba(255,255,255,.78); }
    .favBtn.on{ border-color: rgba(124,92,255,.55); background: rgba(124,92,255,.16); }

    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.60);
      z-index:1000;
      padding:16px;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(720px, 96vw);
      border:1px solid var(--stroke);
      background: rgba(15,20,40,.96);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:14px;
      max-height: 86vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    [data-theme="light"] .modalCard{ background: rgba(255,255,255,.96); }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 6px 10px;
      position:sticky; top:0;
      background: inherit;
      z-index:2;
    }
    .modalHead h3{margin:0; font-size:16px; letter-spacing:.04em; font-family: ui-sans-serif, system-ui;}
    .x{
      cursor:pointer; padding:8px 10px; border-radius:12px;
      border:1px solid var(--stroke); background: rgba(255,255,255,.06);
      font-family: ui-sans-serif, system-ui;
    }
    label{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.06em;text-transform:uppercase}
    input{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius:14px;
      color:var(--ink);
      outline:none;
      font-size:14px;
      font-family: ui-sans-serif, system-ui;
    }
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .note{color:var(--muted); font-size:12px; line-height:1.45; font-family: ui-sans-serif, system-ui;}
    .hrSoft{ border:0; border-top:1px solid var(--stroke); margin: 12px 0; opacity:.9; }

    /* Terms modal bits */
    .termsBox{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background: rgba(255,255,255,.06);
      max-height: 56vh;
      overflow:auto;
      font-family: ui-sans-serif, system-ui;
      color: var(--ink);
    }
    .checkRow{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 6px 0;
      font-family: ui-sans-serif, system-ui;
    }
    .checkRow input{ width:auto; margin-top:3px; }

    @media (max-width:980px){
      .hero{grid-template-columns:1fr}
      .shelf{grid-template-columns: repeat(2, minmax(0, 1fr));}
      h1{font-size:38px}
    }
    @media (max-width:520px){
      h1{font-size:30px}
      .right{max-width:72vw;}
      .row2{grid-template-columns:1fr}
      .shelf{grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px;}
      .bookCard{min-height: 240px;}
      .cover{height: 140px;}
      .meta .name{font-size:13px}
      .meta .desc{font-size:12px}
      .badge{font-size:11px; padding:6px 8px}
      .favBtn{padding:7px 9px; font-size:12px}
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="nav">
      <div class="brand">
        THE KOKER
        <small>Archives</small>
      </div>

      <div class="right">
        <div class="pill" id="themeBtn">üåì <strong>Theme</strong></div>
        <div class="pill" id="settingsBtn">‚öôÔ∏è <strong>Settings</strong></div>
        <div class="pill" id="authBtn"><span class="dot" id="authDot">‚óè</span> <strong id="authText">Guest</strong></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
      <div class="card heroMain">
        <h1>THE KOKER ARCHIVES</h1>
        <p class="subtitle">
          A premium novel-reader: smooth pages, saved progress, light/dark mode,
          and Firebase sync so your reading follows you across devices.
        </p>

        <div class="ctaRow">
          <div class="btn primary" id="openBook1">üìñ Read This is US (Book I)</div>
          <div class="btn" id="openCommunityQuick">üí¨ Community</div>
          <div class="btn" id="openAuthQuick">üë§ Sign in / Sign up</div>
          <div class="btn" id="openSubscribeQuick">üîî Subscribe</div>
        </div>

        <div class="mini">
          <div class="profileLine" style="display:flex;gap:10px;align-items:center">
            <div class="avatar" id="heroAvatar">üë§</div>
            <div style="min-width:0">
              <div class="who" id="whoLine">Guest Reader</div>
              <div class="small" id="whoSub">Progress saved locally ‚Ä¢ Sign in to save to cloud</div>
            </div>
          </div>

          <div class="small" id="announceLine" style="text-align:right;max-width:48ch">
            Announcements are in the tab below ‚Üò
          </div>
        </div>
      </div>

      <div class="card heroSide">
        <div class="stat">
          <div class="k">Readers</div>
          <div class="v" id="readersTotal">‚Äî Total</div>
          <div class="small" style="margin-top:6px;opacity:.85">Unique readers.</div>
        </div>

        <!-- ‚úÖ Subscriber total is private (admin only). Non-admin sees "Private". -->
        <div class="stat">
          <div class="k">Subscribers</div>
          <div class="v" id="subsTotal">Private</div>
          <div class="small" id="subsHint" style="margin-top:6px;opacity:.85">Visible to admin only.</div>
        </div>

        <div class="stat">
          <div class="k">Subscribe for updates</div>
          <div style="display:grid;gap:8px;margin-top:8px">
            <input id="subEmail" placeholder="Email address" inputmode="email" autocomplete="email" />
            <button class="btn primary" id="subBtn" style="justify-content:center" type="button">Subscribe</button>
            <div class="note" id="subMsg"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Favorites (Signed-in only) -->
    <div class="favStrip" id="favStrip">
      <div class="favHead">
        <div style="font-weight:950;letter-spacing:.08em;text-transform:uppercase;font-size:12px;color:var(--muted)">Favorites</div>
        <div class="small" id="favHint">Your shortcuts</div>
      </div>
      <div class="favRow" id="favRow"></div>
    </div>

    <div class="sectionTitle">
      <h2>Community</h2>
      <div class="tabRow">
        <button class="tabBtn active" data-tab="tabComments" type="button">üí¨ Comments</button>
        <button class="tabBtn" data-tab="tabAnnounce" type="button">üì£ Announcements</button>
      </div>
    </div>

    <div class="tabShell">
      <div class="tabInner">
        <div class="tabPanel show" id="tabComments">
          <div id="commentPreview">
            <!-- JS will replace this with a 1-at-a-time carousel -->
            <div style="opacity:.85;line-height:1.6">
              Loading comment preview‚Ä¶
              <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn primary" id="openCommunityFromTab" type="button">Open Community</button>
                <button class="btn" id="openBookFromTab" type="button">Open Book I</button>
              </div>
            </div>
          </div>
        </div>

        <div class="tabPanel" id="tabAnnounce">
          <div id="announceMount">Loading‚Ä¶</div>
        </div>
      </div>

      <div class="pHint">
        <span id="tabHintLeft">Opens Community inside Reader</span>
        <span id="tabHintRight">THIS IS US Book I ‚Ä¢ Where We Began</span>
      </div>
    </div>

    <div class="sectionTitle">
      <h2>Library</h2>
      <div class="small" id="libraryHint">Live + Coming Soon</div>
    </div>

    <div class="searchRow">
      <input class="search" id="searchBooks" placeholder="Search books‚Ä¶ (future-proof for many books)" />
      <div class="pill" id="showAllBtn">üîé <strong>Show All</strong></div>
    </div>

    <div class="shelf" id="shelf">
      <div class="bookCard" id="book1Card" role="button" aria-label="Open Book I" data-book="book1" data-title="THIS IS US Book I Where We Began">
        <div class="badge live">Live</div>
        <div class="badge new" id="newBadge_book1" style="display:none">NEW</div>
        <div class="cover"><img src="./assets/cover-book1.png" alt="Book 1 Cover"></div>
        <div class="meta">
          <p class="name">THIS IS US (Book I) ‚Äî Where We Began</p>
          <p class="desc">Mukeh arrives. Francess is the standard. Awareness begins.</p>
        </div>
        <button class="favBtn" id="favBtn_book1" type="button" title="Favorite">‚òÜ Favorite</button>
      </div>

      <div class="bookCard" id="book2Card" role="button" aria-label="Coming soon book" data-book="coming" data-title="THIS IS US Book II Coming Soon">
        <div class="badge soon">Coming Soon</div>
        <div class="cover"><img src="./assets/back-book1.png" alt="Coming Soon"></div>
        <div class="meta">
          <p class="name">THIS IS US Book II ‚Äî Coming Soon</p>
          <p class="desc">A new season is loading. New pressure. New cost. New choices.</p>
        </div>
        <button class="favBtn" id="favBtn_coming" type="button" title="Favorite">‚òÜ Favorite</button>
      </div>

      <!-- book3/book4 point to the same placeholder "coming" to avoid broken read mapping -->
      <div class="bookCard" id="book3Card" role="button" aria-label="Coming soon book" data-book="coming" data-title="THIS IS US Book III Coming Soon">
        <div class="badge soon">Coming Soon</div>
        <div class="cover"><img src="./assets/back-book1.png" alt="Coming Soon"></div>
        <div class="meta">
          <p class="name">THIS IS US Book III ‚Äî Coming Soon</p>
          <p class="desc">Some friendships become fault lines. Some love becomes a mirror.</p>
        </div>
        <button class="favBtn" id="favBtn_coming3" type="button" title="Favorite">‚òÜ Favorite</button>
      </div>

      <div class="bookCard" id="book4Card" role="button" aria-label="Coming soon book" data-book="coming" data-title="Book IV Coming Soon">
        <div class="badge soon">Coming Soon</div>
        <div class="cover"><img src="./assets/back-book1.png" alt="Coming Soon"></div>
        <div class="meta">
          <p class="name">Book IV ‚Äî Coming Soon</p>
          <p class="desc">The past returns. The narrative changes. The costs rise.</p>
        </div>
        <button class="favBtn" id="favBtn_coming4" type="button" title="Favorite">‚òÜ Favorite</button>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Account</h3>
        <div class="x" id="authClose">‚úï</div>
      </div>

      <div class="note" id="authHint" style="padding:0 6px 6px;">Loading‚Ä¶</div>

      <div class="row2" style="padding:6px;">
        <div>
          <label>Email</label>
          <input id="authEmail" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div>
          <label>Password</label>
          <input id="authPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" autocomplete="current-password" />
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;padding:6px;">
        <button class="btn primary" id="btnSignIn" type="button">Sign In</button>
        <button class="btn" id="btnSignUp" type="button">Sign Up</button>
        <button class="btn" id="btnSignOut" type="button" style="display:none">Sign Out</button>
        <div class="note" id="authMsg" style="align-self:center"></div>
      </div>

      <hr class="hrSoft">

      <div class="note" style="padding:0 6px 6px;">
        After signing in, set your display name + avatar inside <strong>Settings</strong>.
      </div>

      <div style="padding:6px;">
        <button class="btn" id="goSettings" type="button">‚öôÔ∏è Open Settings</button>
      </div>
    </div>
  </div>

  <!-- SUBSCRIBE POPUP MODAL -->
  <div class="modal" id="subModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Get Updates</h3>
        <div class="x" id="subClose">‚úï</div>
      </div>
      <div class="note" style="padding:0 6px 10px;">
        Want a heads-up when a <strong>new chapter</strong> or <strong>new book</strong> drops?
        Subscribe and you‚Äôll never miss it.
      </div>
      <div style="padding:6px;display:grid;gap:10px;">
        <div>
          <label>Email</label>
          <input id="subModalEmail" placeholder="you@example.com" autocomplete="email" />
          <div class="note" id="subModalMsg" style="margin-top:8px;"></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="subModalBtn" type="button">üîî Subscribe</button>
          <button class="btn" id="subModalLater" type="button">Maybe later</button>
        </div>
        <div class="note" style="opacity:.85">
          If subscribe is set to ‚Äúsign-in required‚Äù, sign in first ‚Äî then subscribe.
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ TERMS MODAL (LIBRARY TOO) -->
  <div class="modal" id="termsModal">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Terms & Conditions</h3>
        <div></div>
      </div>

      <div class="termsBox" id="termsText">
        <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase">THE KOKER ARCHIVES ‚Äî Terms</div>
        <p class="note" style="margin-top:10px">Last updated: February 15, 2026</p>

        <p><strong>1) Acceptance</strong><br>
          By accessing or using THE KOKER ARCHIVES (the ‚ÄúSite‚Äù), you agree to these Terms. If you do not agree, you may not use the Site.
        </p>
        <p><strong>2) Eligibility</strong><br>
          You represent that you are able to form a legally binding agreement. If you are under the age required in your jurisdiction,(13+) use the Site only with a parent/guardian‚Äôs consent.
        </p>
        <p><strong>3) Content & Reader Experience</strong><br>
          The story, chapters, artwork, and design are owned by the Site owner and are protected by copyright. You may read for personal use only. You may not copy, repost, or redistribute the content without written permission.
        </p>
        <p><strong>4) Accounts</strong><br>
          Creating an account is optional. You are responsible for keeping your login credentials secure. The owner may suspend accounts that violate these Terms.
        </p>
        <p><strong>5) User Submissions</strong><br>
          If you post comments or feedback, you agree not to post illegal, harmful, abusive, or infringing content. The owner may remove content at any time.
        </p>
        <p><strong>6) Notifications (Optional)</strong><br>
          If you opt in to email and/or SMS notifications, you consent to receive updates about new chapters or announcements.
        </p>
        <p><strong>7) Privacy</strong><br>
          The Site may store basic account data (email), reading progress, and (if you opt in) notification contact details. Subscriber lists are private and visible only to the owner/admin.
        </p>
        <p><strong>8) Availability & Changes</strong><br>
          The Site may change, pause, or stop features at any time. Chapters and features may be updated without notice.
        </p>
        <p><strong>9) Disclaimer</strong><br>
          The Site is provided ‚Äúas is‚Äù without warranties of any kind.
        </p>
        <p><strong>10) Limitation of Liability</strong><br>
          To the maximum extent permitted by law, the owner will not be liable for indirect or consequential damages.
        </p>
        <p><strong>11) Contact</strong><br>
          For questions, removal requests, or opt-out requests, contact the site owner.
        </p>
      </div>

      <div class="checkRow">
        <input type="checkbox" id="agreeTerms">
        <div class="note">I have read and agree to the Terms & Conditions.</div>
      </div>

      <div style="display:grid; gap:10px; padding-top:10px">
        <button class="btn primary" id="acceptTermsBtn" type="button">Accept & Continue</button>
        <div class="note" id="termsMsg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from "./firebase-config.js";
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, serverTimestamp,
      query, limit, getDocs, orderBy
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    import { wireTermsGate } from "./terms-gate.js";
    import { renderAnnouncements, submitSubscriber, getLatestChapterNumber, getLastSeenChapterSignedIn } from "./public-feed.js";

    // ‚úÖ your admin UID
    const ADMIN_UID = "He8L6OfKude0nLHXQcTAjJohK2k1";

    // scroll lock helpers (for modals + terms)
    let __scrollY = 0;
    function lockScroll(){
      __scrollY = window.scrollY || 0;
      document.body.style.position = "fixed";
      document.body.style.top = `-${__scrollY}px`;
      document.body.style.left = "0";
      document.body.style.right = "0";
      document.body.style.width = "100%";
      document.body.style.overflow = "hidden";
    }
    function unlockScroll(){
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.left = "";
      document.body.style.right = "";
      document.body.style.width = "";
      document.body.style.overflow = "";
      window.scrollTo(0, __scrollY);
    }

    // ‚úÖ Terms enforcement on library too
    wireTermsGate({ lockScroll, unlockScroll });

    // Theme
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.dataset.theme = savedTheme === "light" ? "light" : "dark";

    // Firebase init (safe)
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // Theme btn
    const themeBtn = document.getElementById("themeBtn");
    themeBtn.addEventListener("click", async ()=>{
      const next = (document.documentElement.dataset.theme === "light") ? "dark" : "light";
      document.documentElement.dataset.theme = next;
      localStorage.setItem("theme", next);
      if(UID){
        try{ await setDoc(doc(db,"users",UID), { theme: next, updatedAt: serverTimestamp() }, { merge:true }); }catch{}
      }
    });

    // Quick nav
    document.getElementById("settingsBtn").addEventListener("click", ()=> location.href = "settings.html");

    const openAuthQuick = document.getElementById("openAuthQuick");
    const openSubscribeQuick = document.getElementById("openSubscribeQuick");

    document.getElementById("openBook1").addEventListener("click", ()=> openBook("book1"));
    document.getElementById("book1Card").addEventListener("click", ()=> openBook("book1"));
    document.getElementById("book2Card").addEventListener("click", ()=> openBook("coming"));
    document.getElementById("book3Card").addEventListener("click", ()=> openBook("coming"));
    document.getElementById("book4Card").addEventListener("click", ()=> openBook("coming"));

    document.getElementById("openCommunityQuick").addEventListener("click", ()=>{
      location.href = "read.html?book=book1&open=community";
    });

    document.getElementById("openCommunityFromTab").addEventListener("click", ()=>{
      location.href = "read.html?book=book1&open=community";
    });
    document.getElementById("openBookFromTab").addEventListener("click", ()=> openBook("book1"));

    function openBook(bookId){
      trackHistory(bookId).catch(()=>{});
      location.href = `read.html?book=${encodeURIComponent(bookId)}`;
    }

    // Tabs wiring
    const tabBtns = Array.from(document.querySelectorAll(".tabBtn"));
    const tabPanels = {
      tabComments: document.getElementById("tabComments"),
      tabAnnounce: document.getElementById("tabAnnounce"),
    };
    const tabHintLeft = document.getElementById("tabHintLeft");
    function setTab(id){
      tabBtns.forEach(b=> b.classList.toggle("active", b.getAttribute("data-tab") === id));
      Object.keys(tabPanels).forEach(k=> tabPanels[k].classList.toggle("show", k === id));
      tabHintLeft.textContent = (id === "tabComments") ? "Opens Community inside Reader" : "Latest updates from Admin";
    }
    tabBtns.forEach(btn=> btn.addEventListener("click", ()=> setTab(btn.getAttribute("data-tab"))) );

    // Auth modal wiring
    const authModal = document.getElementById("authModal");
    const authBtn = document.getElementById("authBtn");
    const authClose = document.getElementById("authClose");
    const goSettings = document.getElementById("goSettings");

    function openAuth(){
      authModal.classList.add("show");
      authModal.setAttribute("aria-hidden","false");
      lockScroll();
      document.getElementById("authMsg").textContent = "";
    }
    function closeAuth(){
      authModal.classList.remove("show");
      authModal.setAttribute("aria-hidden","true");
      unlockScroll();
    }

    authBtn.addEventListener("click", openAuth);
    openAuthQuick.addEventListener("click", openAuth);
    authClose.addEventListener("click", closeAuth);
    authModal.addEventListener("click",(e)=>{ if(e.target === authModal) closeAuth(); });
    goSettings.addEventListener("click", ()=> location.href = "settings.html");

    // Subscribe popup modal wiring
    const subModal = document.getElementById("subModal");
    const subClose = document.getElementById("subClose");
    const subModalBtn = document.getElementById("subModalBtn");
    const subModalLater = document.getElementById("subModalLater");
    const subModalEmail = document.getElementById("subModalEmail");
    const subModalMsg = document.getElementById("subModalMsg");

    function openSub(){
      subModal.classList.add("show");
      subModal.setAttribute("aria-hidden","false");
      lockScroll();
      subModalMsg.textContent = "";
    }
    function closeSub(){
      subModal.classList.remove("show");
      subModal.setAttribute("aria-hidden","true");
      unlockScroll();
    }

    openSubscribeQuick.addEventListener("click", openSub);
    subClose.addEventListener("click", closeSub);
    subModal.addEventListener("click", (e)=>{ if(e.target === subModal) closeSub(); });

    subModalLater.addEventListener("click", ()=>{
      const next = Date.now() + 7*24*60*60*1000;
      localStorage.setItem("subPromptNextAt", String(next));
      closeSub();
    });

    // Auth bits
    const authHint = document.getElementById("authHint");
    const authEmail = document.getElementById("authEmail");
    const authPass  = document.getElementById("authPass");
    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignUp = document.getElementById("btnSignUp");
    const btnSignOut= document.getElementById("btnSignOut");
    const authMsg   = document.getElementById("authMsg");

    const heroAvatar = document.getElementById("heroAvatar");
    const whoLine = document.getElementById("whoLine");
    const whoSub  = document.getElementById("whoSub");
    const authDot = document.getElementById("authDot");
    const authText= document.getElementById("authText");

    function setAvatar(url){
      const u = (typeof url === "string" && url.trim()) ? url.trim() : "";
      heroAvatar.innerHTML = u ? `<img src="${u}" alt="Profile">` : "üë§";
    }

    let UID = null;

    onAuthStateChanged(auth, async (user)=>{
      UID = user ? user.uid : null;

      if(!user){
        authDot.style.color = "rgba(255,255,255,.65)";
        authText.textContent = "Guest";
        authHint.textContent = "Guest mode ‚Äî progress saved locally. Sign in to sync + favorites + history.";
        btnSignOut.style.display = "none";
        btnSignIn.style.display = "";
        btnSignUp.style.display = "";

        whoLine.textContent = "Guest Reader";
        whoSub.textContent = "Progress saved locally ‚Ä¢ Sign in to save to cloud";
        setAvatar("");

        setFavoritesUI(null);

        // subscribers count stays private
        subsTotal.textContent = "Private";
        document.getElementById("subsHint").textContent = "Visible to admin only.";
      }else{
        authDot.style.color = "rgba(0,255,198,.9)";
        authText.textContent = "Signed in";
        authHint.textContent = "Signed in ‚Äî your theme, favorites, and history can sync.";
        btnSignOut.style.display = "";
        btnSignIn.style.display = "none";
        btnSignUp.style.display = "none";

        try{
          const snap = await getDoc(doc(db,"users",user.uid));
          const d = snap.exists() ? (snap.data() || {}) : {};
          const name = (d.displayName && String(d.displayName).trim()) ? String(d.displayName).trim() : (user.email || "Reader");
          whoLine.textContent = name;
          whoSub.textContent = user.email || "Signed in";
          setAvatar(d.photoURL || "");

          if(d.theme === "light" || d.theme === "dark"){
            document.documentElement.dataset.theme = d.theme;
            localStorage.setItem("theme", d.theme);
          }
        }catch{
          whoLine.textContent = user.email || "Signed in";
          whoSub.textContent = "Signed in";
          setAvatar("");
        }

        try{
          await setDoc(doc(db,"users",user.uid), {
            email: user.email || null,
            updatedAt: serverTimestamp()
          }, { merge:true });
        }catch{}

        await loadFavorites().catch(()=>{});

        // ‚úÖ admin-only subscriber count
        if(user.uid === ADMIN_UID){
          await loadSubscribersCount().catch(()=>{});
          document.getElementById("subsHint").textContent = "Admin view.";
        }else{
          subsTotal.textContent = "Private";
          document.getElementById("subsHint").textContent = "Visible to admin only.";
        }
      }

      await updateNewBadges().catch(()=>{});
    });

    btnSignIn.addEventListener("click", async ()=>{
      authMsg.textContent = "";
      const email = (authEmail.value || "").trim();
      const pass  = (authPass.value || "").trim();
      if(!email || !pass){ authMsg.textContent = "Enter email + password."; return; }
      try{ await signInWithEmailAndPassword(auth, email, pass); authMsg.textContent = "Signed in ‚úÖ"; }
      catch(e){ authMsg.textContent = (e?.message || "Could not sign in."); }
    });

    btnSignUp.addEventListener("click", async ()=>{
      authMsg.textContent = "";
      const email = (authEmail.value || "").trim();
      const pass  = (authPass.value || "").trim();
      if(!email || !pass){ authMsg.textContent = "Enter email + password."; return; }
      if(pass.length < 6){ authMsg.textContent = "Password must be at least 6 characters."; return; }
      try{ await createUserWithEmailAndPassword(auth, email, pass); authMsg.textContent = "Account created ‚úÖ"; }
      catch(e){ authMsg.textContent = (e?.message || "Could not sign up."); }
    });

    btnSignOut.addEventListener("click", async ()=>{
      authMsg.textContent = "";
      try{ await signOut(auth); authMsg.textContent = "Signed out ‚úÖ"; }
      catch(e){ authMsg.textContent = (e?.message || "Could not sign out."); }
    });

    // Subscribers
    const subEmail = document.getElementById("subEmail");
    const subBtn = document.getElementById("subBtn");
    const subMsg = document.getElementById("subMsg");
    const subsTotal = document.getElementById("subsTotal");

    async function loadSubscribersCount(){
      // admin-only call
      const snap = await getDocs(query(collection(db,"subscribers"), limit(1000)));
      subsTotal.textContent = `${snap.size} Total`;
    }

    subBtn.addEventListener("click", async ()=>{
      subMsg.textContent = "";
      subBtn.disabled = true;
      subBtn.textContent = "Saving‚Ä¶";
      try{
        const res = await submitSubscriber({ email: subEmail.value, source:"library_card" });
        subMsg.textContent = res.msg;
        if(res.ok){
          subEmail.value = "";
          if(UID && UID === ADMIN_UID){
            await loadSubscribersCount().catch(()=>{});
          }
        }
      }finally{
        subBtn.disabled = false;
        subBtn.textContent = "Subscribe";
      }
    });

    subModalBtn.addEventListener("click", async ()=>{
      subModalMsg.textContent = "";
      subModalBtn.disabled = true;
      subModalBtn.textContent = "Saving‚Ä¶";
      try{
        const res = await submitSubscriber({ email: subModalEmail.value, source:"library_popup" });
        subModalMsg.textContent = res.msg;
        if(res.ok){
          subModalEmail.value = "";
          const next = Date.now() + 60*24*60*60*1000;
          localStorage.setItem("subPromptNextAt", String(next));
          if(UID && UID === ADMIN_UID){
            await loadSubscribersCount().catch(()=>{});
          }
        }
      }finally{
        subModalBtn.disabled = false;
        subModalBtn.textContent = "üîî Subscribe";
      }
    });

    function maybeShowSubscribePopup(){
      const nextAt = Number(localStorage.getItem("subPromptNextAt") || "0") || 0;
      if(Date.now() >= nextAt){
        setTimeout(()=> openSub(), 700);
      }
    }

    // Readers total (public)
    const readersTotal = document.getElementById("readersTotal");
    async function loadReadersTotal(){
      try{
        const snap = await getDoc(doc(db,"stats","book1"));
        if(snap.exists()){
          const d = snap.data() || {};
          const n = Number(d.totalReaders || 0);
          readersTotal.textContent = `${n.toLocaleString()} Total`;
          return;
        }
      }catch{}
      readersTotal.textContent = "‚Äî Total";
    }

    // ===========================
    // ‚úÖ Comment Preview Carousel (ONE AT A TIME)
    // ===========================
    let __cTimer = null;

    function stopCarousel(){
      if(__cTimer) clearInterval(__cTimer);
      __cTimer = null;
    }

    function startCarousel(nextFn, intervalMs){
      stopCarousel();
      __cTimer = setInterval(nextFn, Math.max(1800, Number(intervalMs || 4200)));
    }

    function fmtWhen(ms){
      try{
        const d = new Date(ms);
        return d.toLocaleDateString(undefined, { month:"short", day:"numeric" });
      }catch{
        return "";
      }
    }

    function tsToMs(ts){
      if(!ts) return 0;
      if(typeof ts === "number") return ts;
      if(ts.toMillis) return ts.toMillis();
      if(ts.seconds) return Number(ts.seconds) * 1000;
      return 0;
    }

    async function loadPreview(){
      const mount = document.getElementById("commentPreview");
      if(!mount) return;

      mount.innerHTML = `<div style="opacity:.85;line-height:1.6">Loading comment preview‚Ä¶</div>`;

      let items = [];
      try{
        const qy = query(
          collection(db,"books","book1","comments"),
          orderBy("createdAt","desc"),
          limit(10)
        );
        const snap = await getDocs(qy);
        snap.forEach(s=>{
          const d = s.data() || {};
          const text = String(d.text || "").trim();
          if(!text) return;
          items.push({
            id: s.id,
            name: String(d.name || "Reader"),
            text,
            at: tsToMs(d.createdAt) || Date.now()
          });
        });
      }catch(e){
        mount.innerHTML = `
          <div style="opacity:.85;line-height:1.6">
            Couldn‚Äôt load comments right now.
            <div class="small" style="margin-top:8px;">${escapeHtml(e?.message || "")}</div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="openCommunityFromTab" type="button">Open Community</button>
              <button class="btn" id="openBookFromTab" type="button">Open Book I</button>
            </div>
          </div>
        `;
        // re-wire the buttons (because we replaced HTML)
        mount.querySelector("#openCommunityFromTab")?.addEventListener("click", ()=>{
          location.href = "read.html?book=book1&open=community";
        });
        mount.querySelector("#openBookFromTab")?.addEventListener("click", ()=> openBook("book1"));
        return;
      }

      if(!items.length){
        mount.innerHTML = `
          <div class="cWrap">
            <div class="cViewport">
              <div style="padding:12px;opacity:.9;line-height:1.6">
                No comments yet ‚Äî be the first to leave one inside the Reader.
                <div class="cActions">
                  <button class="btn primary" id="openCommunityFromTab2" type="button">Open Community</button>
                  <button class="btn" id="openBookFromTab2" type="button">Open Book I</button>
                </div>
              </div>
            </div>
          </div>
        `;
        mount.querySelector("#openCommunityFromTab2")?.addEventListener("click", ()=>{
          location.href = "read.html?book=book1&open=community";
        });
        mount.querySelector("#openBookFromTab2")?.addEventListener("click", ()=> openBook("book1"));
        return;
      }

      // Build carousel (1 slide visible)
      const slidesHtml = items.map((it)=>`
        <div class="cSlide">
          <div class="cCard">
            <div class="cTop">
              <div class="cName">${escapeHtml(it.name)}</div>
              <div class="cMeta">${escapeHtml(fmtWhen(it.at))}</div>
            </div>
            <div class="cText">${escapeHtml(it.text)}</div>
            <div class="cActions">
              <button class="btn primary" data-go="community" type="button">Open Community</button>
              <button class="btn" data-go="book" type="button">Open Book I</button>
            </div>
          </div>
        </div>
      `).join("");

      const dotsHtml = items.map((_,i)=> `<span class="cDot" data-dot="${i}"></span>`).join("");

      mount.innerHTML = `
        <div class="cWrap">
          <div class="cViewport" id="cViewport">
            <div class="cTrack" id="cTrack">${slidesHtml}</div>
          </div>
          <div class="cNav">
            <div class="cNavLeft">
              <button class="cIconBtn" id="cPrev" type="button">‚Äπ</button>
              <button class="cIconBtn" id="cNext" type="button">‚Ä∫</button>
            </div>
            <div class="cDots" id="cDots">${dotsHtml}</div>
          </div>
        </div>
      `;

      const track = document.getElementById("cTrack");
      const viewport = document.getElementById("cViewport");
      const dots = Array.from(document.querySelectorAll(".cDot"));

      let idx = 0;

      function apply(){
        const w = viewport.clientWidth || 1;
        track.style.transform = `translateX(${-idx * w}px)`;
        dots.forEach((d,i)=> d.classList.toggle("on", i === idx));
      }

      function prev(){
        idx = (idx - 1 + items.length) % items.length;
        apply();
      }

      function next(){
        idx = (idx + 1) % items.length;
        apply();
      }

      // Buttons
      document.getElementById("cPrev")?.addEventListener("click", ()=>{
        prev(); startCarousel(next, 4200);
      });
      document.getElementById("cNext")?.addEventListener("click", ()=>{
        next(); startCarousel(next, 4200);
      });

      dots.forEach((d)=>{
        d.addEventListener("click", ()=>{
          const n = Number(d.getAttribute("data-dot") || "0") || 0;
          idx = Math.max(0, Math.min(items.length-1, n));
          apply();
          startCarousel(next, 4200);
        });
      });

      // Actions inside slides
      mount.querySelectorAll('[data-go="community"]').forEach(btn=>{
        btn.addEventListener("click", ()=> location.href = "read.html?book=book1&open=community");
      });
      mount.querySelectorAll('[data-go="book"]').forEach(btn=>{
        btn.addEventListener("click", ()=> openBook("book1"));
      });

      // Resize-safe
      const ro = new ResizeObserver(()=> apply());
      ro.observe(viewport);

      // Swipe
      let sx = 0, dx = 0, dragging = false;
      viewport.addEventListener("touchstart",(e)=>{
        if(!e.touches?.length) return;
        dragging = true;
        sx = e.touches[0].clientX;
        dx = 0;
        stopCarousel();
      }, { passive:true });
      viewport.addEventListener("touchmove",(e)=>{
        if(!dragging || !e.touches?.length) return;
        dx = e.touches[0].clientX - sx;
      }, { passive:true });
      viewport.addEventListener("touchend",()=>{
        if(!dragging) return;
        dragging = false;
        if(Math.abs(dx) > 45){
          if(dx > 0) prev(); else next();
        }
        startCarousel(next, 4200);
      });

      // Start
      apply();
      startCarousel(next, 4200);
    }

    async function loadAnnouncementsTab(){
      await renderAnnouncements({ mountId:"announceMount", max: 4 });
    }

    // NEW badge logic
    async function updateNewBadges(){
      const latest = await getLatestChapterNumber("book1");
      if(latest <= 0){
        document.getElementById("newBadge_book1").style.display = "none";
        return;
      }

      let seen = 0;
      if(UID){
        seen = await getLastSeenChapterSignedIn("book1", UID);
      }else{
        seen = Number(localStorage.getItem("lastSeenChapter:book1") || "0") || 0;
      }

      const badge = document.getElementById("newBadge_book1");
      badge.style.display = (latest > seen) ? "block" : "none";
    }

    // Favorites + History (signed-in only)
    const favStrip = document.getElementById("favStrip");
    const favRow = document.getElementById("favRow");

    const BOOKS = [
      { id:"book1", title:"THIS IS US (Book I) ‚Äî Where We Began", desc:"Mukeh arrives. Francess is the standard.", cover:"./assets/cover-book1.png", href:"read.html?book=book1" },
      { id:"coming", title:"THIS IS US Book II ‚Äî Coming Soon", desc:"A new season is loading.", cover:"./assets/back-book1.png", href:"read.html?book=coming" },
      { id:"coming3", title:"THIS IS US Book III ‚Äî Coming Soon", desc:"Fault lines. Mirrors.", cover:"./assets/back-book1.png", href:"read.html?book=coming" },
      { id:"coming4", title:"Book IV ‚Äî Coming Soon", desc:"The past returns.", cover:"./assets/back-book1.png", href:"read.html?book=coming" },
    ];

    let favoritesMap = {};

    function setFavoritesUI(map){
      favoritesMap = map || {};
      BOOKS.forEach(b=>{
        const btn = document.getElementById(`favBtn_${b.id}`);
        if(!btn) return;
        const on = !!favoritesMap[b.id];
        btn.classList.toggle("on", on);
        btn.textContent = on ? "‚òÖ Favorited" : "‚òÜ Favorite";
      });

      if(!UID){
        favStrip.classList.remove("show");
        favRow.innerHTML = "";
        return;
      }

      const favIds = Object.keys(favoritesMap).filter(k=> favoritesMap[k]);
      if(!favIds.length){
        favStrip.classList.add("show");
        favRow.innerHTML = `<div class="small" style="padding:6px 2px;">No favorites yet ‚Äî tap ‚òÜ on a book to pin it here.</div>`;
        return;
      }

      favStrip.classList.add("show");
      const cards = favIds.map(id=>{
        const b = BOOKS.find(x=> x.id === id);
        if(!b) return "";
        return `
          <div class="miniCard" role="button" aria-label="Open ${escapeHtml(b.title)}" data-open="${escapeHtml(b.href)}">
            <div class="miniCover"><img src="${escapeHtml(b.cover)}" alt=""></div>
            <div class="miniMeta">
              <div class="miniName">${escapeHtml(b.title)}</div>
              <div class="miniSub">${escapeHtml(b.desc)}</div>
            </div>
          </div>
        `;
      }).join("");

      favRow.innerHTML = cards;
      favRow.querySelectorAll("[data-open]").forEach(el=>{
        el.addEventListener("click", ()=> location.href = el.getAttribute("data-open"));
      });
    }

    async function loadFavorites(){
      if(!UID) return;
      const ref = doc(db, "users", UID, "meta", "library");
      const snap = await getDoc(ref);
      const d = snap.exists() ? (snap.data() || {}) : {};
      setFavoritesUI(d.favorites || {});
    }

    async function toggleFavorite(bookId){
      if(!UID){
        openAuth();
        authMsg.textContent = "Sign in to use Favorites.";
        return;
      }
      const next = { ...favoritesMap };
      next[bookId] = !next[bookId];
      setFavoritesUI(next);

      try{
        await setDoc(doc(db, "users", UID, "meta", "library"), {
          favorites: next,
          updatedAt: serverTimestamp()
        }, { merge:true });
      }catch{
        await loadFavorites().catch(()=>{});
      }
    }

    async function trackHistory(bookId){
      if(!UID) return;
      const ref = doc(db, "users", UID, "meta", "library");
      const snap = await getDoc(ref);
      const d = snap.exists() ? (snap.data() || {}) : {};
      const history = Array.isArray(d.history) ? d.history : [];
      const now = Date.now();

      const filtered = history.filter(h=> (h && h.bookId) ? h.bookId !== bookId : true);
      filtered.unshift({ bookId, at: now });
      const trimmed = filtered.slice(0, 30);

      await setDoc(ref, { history: trimmed, updatedAt: serverTimestamp() }, { merge:true });
    }

    BOOKS.forEach(b=>{
      const btn = document.getElementById(`favBtn_${b.id}`);
      if(btn){
        btn.addEventListener("click", (e)=>{
          e.preventDefault();
          e.stopPropagation();
          toggleFavorite(b.id).catch(()=>{});
        });
      }
    });

    // Search filter
    const shelf = document.getElementById("shelf");
    const searchBooks = document.getElementById("searchBooks");
    const showAllBtn = document.getElementById("showAllBtn");

    function applySearch(){
      const q = String(searchBooks.value || "").trim().toLowerCase();
      const cards = Array.from(shelf.querySelectorAll(".bookCard"));
      cards.forEach(c=>{
        const title = String(c.getAttribute("data-title") || "").toLowerCase();
        const show = !q || title.includes(q);
        c.style.display = show ? "" : "none";
      });
    }
    searchBooks.addEventListener("input", applySearch);
    showAllBtn.addEventListener("click", ()=>{ searchBooks.value=""; applySearch(); });

    // Init
    (async ()=>{
      await loadPreview().catch(()=>{});
      await loadAnnouncementsTab().catch(()=>{});
      await loadReadersTotal().catch(()=>{});
      await updateNewBadges().catch(()=>{});
      maybeShowSubscribePopup();

      // If user switches away and back, keep carousel smooth
      document.addEventListener("visibilitychange", ()=>{
        if(document.hidden) stopCarousel();
      });
    })();
  </script>
</body>
</html>
