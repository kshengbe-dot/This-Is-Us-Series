<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>THE KOKER ARCHIVES‚Äî Reader</title>

  <style>
    :root{
      --bg:#0B1020;
      --paper:#0F1731;
      --ink:#EAF0FF;
      --muted:#9FB0D6;
      --stroke:rgba(255,255,255,.12);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --bar: rgba(10,14,28,.88);
      --chip: rgba(255,255,255,.06);
      --glow: rgba(124,92,255,.22);

      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);

      --footerSpace: 58px;
      --padX: 22px;
      --padT: 26px;
      --padB: calc(20px + var(--footerSpace));
      --radius: 18px;
    }

    [data-theme="light"]{
      --bg:#F7F8FB;
      --paper:#FFFFFF;
      --ink:#0F172A;
      --muted:#475569;
      --stroke:rgba(2,6,23,.10);
      --shadow: 0 18px 60px rgba(2,6,23,.12);
      --bar: rgba(255,255,255,.92);
      --chip: rgba(2,6,23,.04);
      --glow: rgba(124,92,255,.15);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      overflow:hidden;
      color:var(--ink);
      background:
        radial-gradient(1200px 900px at 30% 10%, var(--glow), transparent 60%),
        var(--bg);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .top{
      position:fixed; left:0; right:0; top:0;
      z-index:60;
      border-bottom:1px solid var(--stroke);
      background: var(--bar);
      backdrop-filter: blur(12px);
      padding: calc(10px + var(--safeTop)) 12px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--stroke);
      background: var(--chip);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .chip strong{color:var(--ink); font-weight:900}

    .stage{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 78px 12px 16px;
    }
    .book{
      width:min(1120px, 98vw);
      height:min(740px, 84vh);
      position:relative;
      perspective: 1800px;
    }

    .spread{
      position:absolute; inset:0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .single{ position:absolute; inset:0; display:none; }

    .page{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      height:100%;
    }

    .inner{
      height:100%;
      padding: var(--padT) var(--padX) var(--padB);
      overflow:hidden;
      /* important for stable measurement */
      contain: content;
    }

    .inner h1,.inner h2,.inner h3,.inner h4{
      font-family: ui-sans-serif, system-ui;
      margin:0 0 10px;
      line-height:1.15;
      letter-spacing:.02em;
    }
    .inner h2{font-size:30px}
    .inner h3{font-size:18px}
    .inner h4{font-size:20px}
    .inner p{
      line-height:1.78;
      margin:0 0 14px;
      font-size:16px;
      color:var(--ink);
      overflow-wrap:anywhere;
      word-break:normal;
    }
    .muted{color:var(--muted)}

    .pageNum{
      position:absolute;
      bottom:16px;
      right:16px;
      font-size:12px;
      color:var(--muted);
      pointer-events:none;
    }

    .flip{
      position:absolute; top:0; bottom:0;
      width:50%;
      transform-style:preserve-3d;
      pointer-events:none;
      opacity:0;
      z-index:70;
    }
    .flip.fromRight{ left:50%; transform-origin:left; }
    .flip.fromLeft{ left:0; transform-origin:right; }
    .flip.full{ width:100%; left:0; }
    .flip .front, .flip .back{
      position:absolute; inset:0;
      border-radius:var(--radius);
      overflow:hidden;
      background: var(--paper);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      backface-visibility:hidden;
    }
    .flip .front .inner, .flip .back .inner{
      padding: var(--padT) var(--padX) var(--padB);
      height:100%;
      overflow:hidden;
      contain: content;
    }
    .flip .back{ transform: rotateY(180deg); }

    @keyframes flipForward{ 0%{transform:rotateY(0)} 100%{transform:rotateY(-180deg)} }
    @keyframes flipBackward{ 0%{transform:rotateY(0)} 100%{transform:rotateY(180deg)} }
    .flip.animForward{ opacity:1; animation: flipForward .55s ease-in-out forwards; }
    .flip.animBackward{ opacity:1; animation: flipBackward .55s ease-in-out forwards; }

    .chapter-cover{ text-align:center; padding: 18px 0 10px; }
    .chapter-cover h2{
      margin:0 0 8px; font-size:44px; font-weight:900;
      letter-spacing:.10em; text-transform:uppercase;
    }
    .series-sub{
      margin:0; font-family: ui-sans-serif, system-ui; color:var(--muted);
      font-size:14px; letter-spacing:.05em;
    }
    .author{
      margin:10px 0 0; font-family: ui-sans-serif, system-ui;
      font-size:14px; opacity:.92;
    }
    .chapter-title{ text-align:center; padding:10px 0 6px; }
    .chapter-title h3{
      margin:0; font-size:13px; letter-spacing:.24em; text-transform:uppercase;
      color:var(--muted); font-family: ui-sans-serif, system-ui;
    }
    .chapter-title h4{
      margin:10px 0 0; font-size:30px; font-weight:900;
      font-family: ui-sans-serif, system-ui;
    }
    hr.ornament{
      border:0; border-top:1px solid var(--stroke);
      margin:18px auto; width:66%; position:relative;
    }
    hr.ornament:after{
      content:"‚ú¶"; position:absolute; left:50%;
      transform:translate(-50%,-50%); top:0;
      color:var(--muted); font-size:13px; padding:0 10px;
      background: transparent;
    }
    .scene-break{
      text-align:center; color:var(--muted);
      letter-spacing:.35em; margin:16px 0 18px;
      font-size:14px; user-select:none;
    }
    .dropcap:first-letter{
      float:left; font-size:56px; line-height:.92;
      padding-right:10px; padding-top:6px; font-weight:800;
    }

    .mTop, .mBottom{ display:none; }
    @media (max-width:720px){
      .top{ display:none; }

      :root{
        --padX: 18px;
        --padT: 22px;
        --padB: calc(18px + var(--footerSpace));
      }

      .mTop{
        display:flex;
        position:fixed; left:0; right:0; top:0;
        z-index:80;
        padding: calc(10px + var(--safeTop)) 12px 10px;
        background: var(--bar);
        backdrop-filter: blur(12px);
        border-bottom:1px solid var(--stroke);
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }
      .mTitle{
        display:flex; flex-direction:column;
        line-height:1.1;
        min-width:0;
      }
      .mTitle .t1{
        font-family: ui-sans-serif, system-ui;
        font-weight:900;
        font-size:14px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        max-width: 44vw;
      }
      .mTitle .t2{
        font-family: ui-sans-serif, system-ui;
        font-size:12px;
        color:var(--muted);
      }
      .mBtn{
        border:1px solid var(--stroke);
        background: rgba(0,0,0,.18);
        color:var(--ink);
        padding:10px 12px;
        border-radius:999px;
        font-family: ui-sans-serif, system-ui;
        font-size:13px;
        font-weight:800;
        cursor:pointer;
        user-select:none;
        white-space:nowrap;
      }
      [data-theme="light"] .mBtn{ background: rgba(2,6,23,.06); }

      .mBottom{
        display:flex;
        position:fixed; left:0; right:0; bottom:0;
        z-index:80;
        padding:10px 12px calc(10px + var(--safeBot));
        background: var(--bar);
        backdrop-filter: blur(12px);
        border-top:1px solid var(--stroke);
        gap:10px;
      }
      .mBottom .mBtn{ flex:1; text-align:center; }

      .stage{
        padding: calc(58px + var(--safeTop)) 10px calc(74px + var(--safeBot));
      }
      .book{
        width:98vw;
        height: calc(100vh - (58px + var(--safeTop)) - (74px + var(--safeBot)) - 18px);
      }
      .spread{ display:none; }
      .single{ display:block; }
      .flip{ width:100%; left:0; }
      .flip.fromRight{ left:0; transform-origin:left; }
      .flip.fromLeft{ left:0; transform-origin:right; }

      .inner p{ font-size:16px; line-height:1.82; }
    }

    .measureHost{
      position:fixed;
      left:-9999px;
      top:-9999px;
      visibility:hidden;
      pointer-events:none;
    }

    /* ===== MODALS ===== */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.60);
      z-index:1000;
      padding:16px;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(860px, 96vw);
      border:1px solid var(--stroke);
      background: rgba(15,20,40,.96);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:14px;

      max-height: 86vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    [data-theme="light"] .modalCard{ background: rgba(255,255,255,.96); }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 6px 10px;
      position:sticky; top:0;
      background: inherit;
      z-index:2;
    }
    .modalHead h3{margin:0; font-size:16px; letter-spacing:.04em; font-family: ui-sans-serif, system-ui;}
    .termsBox{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background: rgba(255,255,255,.06);
      max-height: 56vh;
      overflow:auto;
      font-family: ui-sans-serif, system-ui;
      color: var(--ink);
    }
    .note{color:var(--muted); font-size:12px; line-height:1.45; font-family: ui-sans-serif, system-ui;}
    .checkRow{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 6px 0;
      font-family: ui-sans-serif, system-ui;
    }
    .checkRow input{ width:auto; margin-top:3px; }
    .btn2{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .15s ease, background .15s ease;
      user-select:none;
      font-family: ui-sans-serif, system-ui;
    }
    .btn2:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn2.primary{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.16);
    }

    /* community */
    .xBtn{
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      font-family: ui-sans-serif, system-ui;
      user-select:none;
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding: 6px 6px 0;
    }
    .tabBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font: 900 12px ui-sans-serif,system-ui;
      letter-spacing:.04em;
      user-select:none;
    }
    .tabBtn.active{
      color: var(--ink);
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.16);
    }
    .tabPanel{
      display:none;
      padding: 10px 6px 4px;
      font-family: ui-sans-serif, system-ui;
    }
    .tabPanel.show{ display:block; }

    .fieldLabel{
      font: 800 12px ui-sans-serif,system-ui;
      letter-spacing:.06em;
      text-transform:uppercase;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    .inp, .sel, .txt{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      padding:10px 12px;
      border-radius:14px;
      color: var(--ink);
      outline:none;
      font: 600 14px ui-sans-serif,system-ui;
    }
    .txt{ min-height: 110px; resize: vertical; line-height:1.5; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:520px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .miniNote{
      color: var(--muted);
      font: 600 12px ui-sans-serif,system-ui;
      line-height:1.45;
      opacity:.92;
      margin-top:8px;
    }
    .hrSoft{
      border:0;
      border-top:1px solid var(--stroke);
      margin: 10px 0;
      opacity:.9;
    }
  </style>
</head>

<body>
  <!-- Mobile top -->
  <div class="mTop">
    <div class="mBtn" id="mBack">‚Üê Library</div>

    <div class="mTitle">
      <div class="t1" id="mBookTitle">book</div>
      <div class="t2"><span id="mPageLabel">1</span> / <span id="mPageTotal">‚Ä¶</span></div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <div class="mBtn" id="mCommunity">üí¨</div>
      <div class="mBtn" id="mTheme">Theme</div>
    </div>
  </div>

  <!-- Desktop top -->
  <div class="top">
    <div class="row">
      <div class="chip" id="backBtn">‚Üê <strong>Library</strong></div>
      <div class="chip">Book: <strong id="bookTitle">book</strong></div>
      <div class="chip">Page: <strong id="pageLabel">1</strong>/<span id="pageTotal">‚Ä¶</span></div>
      <div class="chip" id="themeBtn">Theme</div>
      <div class="chip" id="communityBtn">üí¨ <strong>Community</strong></div>
      <div class="chip" id="syncChip"><span id="syncDot">‚óè</span> <strong id="syncText">Guest</strong></div>
    </div>
    <div class="row">
      <div class="chip" id="prevBtn">Prev</div>
      <div class="chip" id="nextBtn">Next</div>
    </div>
  </div>

  <!-- Mobile bottom -->
  <div class="mBottom">
    <div class="mBtn" id="mPrev">Prev</div>
    <div class="mBtn" id="mNext">Next</div>
  </div>

  <div class="stage">
    <div class="book" id="bookTap">
      <div class="spread" id="spread">
        <div class="page" id="pageL">
          <div class="inner" id="leftPage"></div>
          <div class="pageNum" id="leftNum"></div>
        </div>
        <div class="page" id="pageR">
          <div class="inner" id="rightPage"></div>
          <div class="pageNum" id="rightNum"></div>
        </div>
      </div>

      <div class="single" id="single">
        <div class="page" id="pageS">
          <div class="inner" id="singlePage"></div>
          <div class="pageNum" id="singleNum"></div>
        </div>
      </div>

      <div class="flip" id="flip">
        <div class="front"><div class="inner" id="flipFront"></div></div>
        <div class="back"><div class="inner" id="flipBack"></div></div>
      </div>
    </div>
  </div>

  <div class="measureHost" id="measureHost"></div>

  <!-- COMMUNITY MODAL -->
  <div class="modal" id="communityModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Community</h3>
        <div class="xBtn" id="communityClose">‚úï</div>
      </div>

      <div class="miniNote" id="communityAuthHint" style="margin:0 6px 6px;">
        Loading‚Ä¶
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-tab="commentsTab">Comments</button>
        <button class="tabBtn" data-tab="ratingTab">Rating</button>
        <button class="tabBtn" data-tab="achTab">Achievements</button>
        <button class="tabBtn" data-tab="guideTab">Guidelines</button>
      </div>

      <div class="tabPanel show" id="commentsTab">
        <div class="miniNote">Leave a comment for this book. (Rating inside comments is optional.)</div>

        <form id="commentForm" style="margin-top:10px;">
          <div class="grid2">
            <div>
              <div class="fieldLabel">Name</div>
              <input class="inp" id="cName" placeholder="Reader" />
            </div>
            <div>
              <div class="fieldLabel">Rating (optional)</div>
              <select class="sel" id="cRating">
                <option value="0">No rating</option>
                <option value="1">‚òÖ 1</option>
                <option value="2">‚òÖ 2</option>
                <option value="3">‚òÖ 3</option>
                <option value="4">‚òÖ 4</option>
                <option value="5">‚òÖ 5</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="fieldLabel">Comment</div>
            <textarea class="txt" id="cText" placeholder="Write your comment‚Ä¶"></textarea>
          </div>

          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;">
            <button class="btn2 primary" type="submit">Post Comment</button>
            <div class="note" id="cMsg"></div>
          </div>
        </form>

        <hr class="hrSoft">

        <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase;color:var(--muted);font-size:12px;">
          Latest comments
        </div>
        <div id="commentsList" style="margin-top:10px;">Loading‚Ä¶</div>
      </div>

      <div class="tabPanel" id="ratingTab">
        <div class="miniNote">Signed-in users can rate once (you can update it anytime).</div>

        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px;">
          <div style="border:1px solid var(--stroke);background:rgba(255,255,255,.06);border-radius:16px;padding:10px 12px;min-width:180px;">
            <div style="font-weight:950">Average</div>
            <div id="ratingSummary" style="margin-top:6px;opacity:.9;">Loading‚Ä¶</div>
          </div>

          <div style="border:1px solid var(--stroke);background:rgba(255,255,255,.06);border-radius:16px;padding:10px 12px;">
            <div class="fieldLabel" style="margin:0 0 6px;">Your rating</div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <select class="sel" id="myRatingSel" style="width:auto;min-width:170px;">
                <option value="0">Select‚Ä¶</option>
                <option value="1">‚òÖ 1</option>
                <option value="2">‚òÖ 2</option>
                <option value="3">‚òÖ 3</option>
                <option value="4">‚òÖ 4</option>
                <option value="5">‚òÖ 5</option>
              </select>
              <button class="btn2 primary" id="saveMyRating" type="button">Save</button>
            </div>
            <div class="note" id="ratingMsg" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <div class="tabPanel" id="achTab">
        <div class="miniNote">Achievements unlock as you read. Guests can see popups, but sign in to save them.</div>
        <div id="achList" style="margin-top:10px;">Loading‚Ä¶</div>
      </div>

      <div class="tabPanel" id="guideTab">
        <div id="guideMount" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- TERMS MODAL -->
  <div class="modal" id="termsModal">
    <div class="modalCard">
      <div class="modalHead">
        <h3>Terms & Conditions</h3>
        <div></div>
      </div>

      <div class="termsBox" id="termsText">
        <div style="font-weight:950;letter-spacing:.10em;text-transform:uppercase">THE KOKER ARCHIVES ‚Äî Terms</div>
        <p class="note" style="margin-top:10px">Last updated: February 15, 2026</p>

        <p><strong>1) Acceptance</strong><br>
          By accessing or using THE KOKER ARCHIVES (the ‚ÄúSite‚Äù), you agree to these Terms. If you do not agree, you may not use the Site.
        </p>
        <p><strong>2) Eligibility</strong><br>
          You represent that you are able to form a legally binding agreement. If you are under the age required in your jurisdiction,(13+) use the Site only with a parent/guardian‚Äôs consent.
        </p>
        <p><strong>3) Content & Reader Experience</strong><br>
          The story, chapters, artwork, and design are owned by the Site owner and are protected by copyright. You may read for personal use only. You may not copy, repost, or redistribute the content without written permission.
        </p>
        <p><strong>4) Accounts</strong><br>
          Creating an account is optional. You are responsible for keeping your login credentials secure. The owner may suspend accounts that violate these Terms.
        </p>
        <p><strong>5) User Submissions</strong><br>
          If you post comments or feedback, you agree not to post illegal, harmful, abusive, or infringing content. The owner may remove content at any time.
        </p>
        <p><strong>6) Notifications (Optional)</strong><br>
          If you opt in to email and/or SMS notifications, you consent to receive updates about new chapters or announcements. SMS messages may be subject to carrier rates and fees. You can opt out by updating your preferences or contacting the owner.
        </p>
        <p><strong>7) Privacy</strong><br>
          The Site may store basic account data (email), reading progress, and (if you opt in) notification contact details. Subscriber lists are private and visible only to the owner/admin.
        </p>
        <p><strong>8) Availability & Changes</strong><br>
          The Site may change, pause, or stop features at any time. Chapters and features may be updated without notice.
        </p>
        <p><strong>9) Disclaimer</strong><br>
          The Site is provided ‚Äúas is‚Äù without warranties of any kind. The owner does not guarantee uninterrupted access or that the Site will be error-free.
        </p>
        <p><strong>10) Limitation of Liability</strong><br>
          To the maximum extent permitted by law, the owner will not be liable for indirect, incidental, special, or consequential damages arising from your use of the Site.
        </p>
        <p><strong>11) Contact</strong><br>
          For questions, removal requests, or opt-out requests, contact the site owner.
        </p>
      </div>

      <div class="checkRow">
        <input type="checkbox" id="agreeTerms">
        <div class="note">I have read and agree to the Terms & Conditions.</div>
      </div>

      <div style="display:grid; gap:10px; padding-top:10px">
        <button class="btn2 primary" id="acceptTermsBtn" type="button">Accept & Continue</button>
        <div class="note" id="termsMsg"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from "./firebase-config.js";
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp,
      collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // --- scroll lock helpers (mobile safe) ---
    let __scrollY = 0;
    function lockScroll(){
      __scrollY = window.scrollY || 0;
      document.body.style.position = "fixed";
      document.body.style.top = `-${__scrollY}px`;
      document.body.style.left = "0";
      document.body.style.right = "0";
      document.body.style.width = "100%";
      document.body.style.overflow = "hidden";
    }
    function unlockScroll(){
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.left = "";
      document.body.style.right = "";
      document.body.style.width = "";
      document.body.style.overflow = "";
      window.scrollTo(0, __scrollY);
    }

    // Terms gate
    import { wireTermsGate } from "./terms-gate.js";
    // (extra args are safe even if terms-gate ignores them)
    wireTermsGate({ lockScroll, unlockScroll });

    // ‚úÖ Reader counting (matches fixed public-feed.js + admin paths)
    import { bumpReaderCountOnce } from "./public-feed.js";

    import {
      renderComments,
      setupCommentForm,
      submitRating,
      loadMyRating,
      renderRatingSummary,
      trackAchievements,
      renderMyAchievements,
      guidelinesHTML
    } from "./reader-community.js";

    const BOOK_FILES = {
      book1: "./books/book1.html",
      coming: "./books/coming-soon.html"
    };

    const params = new URLSearchParams(location.search);
    const bookId = params.get("book") || "book1";
    const bookFile = BOOK_FILES[bookId] || BOOK_FILES.coming;

    document.getElementById("bookTitle").textContent = bookId;
    document.getElementById("mBookTitle").textContent = bookId;

    const deepOpen = params.get("open") || "";
    const deepCommentId = params.get("comment") || "";

    const isMobile = ()=> matchMedia("(max-width:720px)").matches;

    // Theme
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.documentElement.dataset.theme = savedTheme === "light" ? "light" : "dark";

    // Navigation
    function goLibrary(){ location.href = "index.html"; }
    document.getElementById("backBtn").addEventListener("click", goLibrary);
    document.getElementById("mBack").addEventListener("click", goLibrary);

    // DOM refs
    const pageL = document.getElementById("pageL");
    const pageS = document.getElementById("pageS");

    const leftPage = document.getElementById("leftPage");
    const rightPage = document.getElementById("rightPage");
    const singlePage = document.getElementById("singlePage");

    const leftNum = document.getElementById("leftNum");
    const rightNum = document.getElementById("rightNum");
    const singleNum = document.getElementById("singleNum");

    const pageLabel = document.getElementById("pageLabel");
    const pageTotalEl = document.getElementById("pageTotal");
    const mPageLabel = document.getElementById("mPageLabel");
    const mPageTotal = document.getElementById("mPageTotal");

    const flip = document.getElementById("flip");
    const flipFront = document.getElementById("flipFront");
    const flipBack  = document.getElementById("flipBack");

    const measureHost = document.getElementById("measureHost");

    const syncDot = document.getElementById("syncDot");
    const syncText = document.getElementById("syncText");

    // Firebase (safe init)
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let UID = null;

    // ‚úÖ Prevent double counting if guest then later signs in
    const countKey = `readerCounted:${bookId}`;
    async function countReaderOnce(uidOrNull){
      if(localStorage.getItem(countKey) === "1") return;
      try{
        await bumpReaderCountOnce({ bookId, uid: uidOrNull || null });
        localStorage.setItem(countKey, "1");
      }catch{}
    }

    // progress
    const progressKeyLocal = `progress:${bookId}`;
    let i = parseInt(localStorage.getItem(progressKeyLocal) || "0", 10);
    if (isNaN(i) || i < 0) i = 0;

    function progressDocRef(uid){
      return doc(db, "users", uid, "progress", bookId);
    }

    async function loadCloudProgressIfAny(){
      if(!UID) return;
      try{
        const snap = await getDoc(progressDocRef(UID));
        if(snap.exists()){
          const d = snap.data() || {};
          if(Number.isFinite(d.index) && d.index >= 0){
            i = Math.max(i, Math.floor(d.index));
          }
        }
      }catch{}
    }

    async function saveCloudProgress(){
      if(!UID) return;
      try{
        await setDoc(progressDocRef(UID), { index: i, updatedAt: serverTimestamp() }, { merge:true });
      }catch{}
    }

    async function saveCloudTheme(theme){
      if(!UID) return;
      try{
        await setDoc(doc(db,"users",UID), { theme, updatedAt: serverTimestamp() }, { merge:true });
      }catch{}
    }

    onAuthStateChanged(auth, async (user)=>{
      UID = user ? user.uid : null;

      const hint = document.getElementById("communityAuthHint");
      if(hint){
        hint.textContent = UID
          ? "Signed in ‚Äî you can post comments and rate."
          : "Guest mode ‚Äî you can read comments + ratings, but must sign in to post or rate.";
      }

      // ‚úÖ Count reader once (after auth resolves)
      await countReaderOnce(UID);

      if(UID){
        syncDot.style.color = "rgba(0,255,198,.9)";
        syncText.textContent = "Synced";
        try{
          const u = await getDoc(doc(db,"users",UID));
          if(u.exists()){
            const data = u.data() || {};
            if(data.theme === "dark" || data.theme === "light"){
              document.documentElement.dataset.theme = data.theme;
              localStorage.setItem("theme", data.theme);
            }
          }
        }catch{}
      }else{
        syncDot.style.color = "rgba(255,255,255,.65)";
        syncText.textContent = "Guest";
      }

      if(UID){
        await loadCloudProgressIfAny();
        render();
      }
    });

    function toggleTheme(){
      const next = (document.documentElement.dataset.theme === "light") ? "dark" : "light";
      document.documentElement.dataset.theme = next;
      localStorage.setItem("theme", next);
      saveCloudTheme(next);
      paginateAndRender(true);
    }
    document.getElementById("themeBtn").addEventListener("click", toggleTheme);
    document.getElementById("mTheme").addEventListener("click", toggleTheme);

    // Load book HTML
    let BOOK_HTML = "<p class='muted'>Loading‚Ä¶</p>";
    let PAGES = [];

    async function loadBook(){
      const res = await fetch(bookFile, { cache:"no-store" });
      if(!res.ok) throw new Error("Could not load: " + res.status);
      BOOK_HTML = await res.text();
    }

    async function loadChaptersFromCloud(){
      if(bookId !== "book1") return "";
      try{
        const qy = query(collection(db, "books", bookId, "chapters"), orderBy("chapterNumber", "asc"));
        const snap = await getDocs(qy);
        if(snap.empty) return "";
        const parts = [];
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          if(d && typeof d.html === "string" && d.html.trim().length){
            parts.push(d.html.trim());
          }
        });
        if(parts.length === 0) return "";
        return "\n\n<!-- CLOUD_CHAPTERS_START -->\n\n" + parts.join("\n\n") + "\n\n<!-- CLOUD_CHAPTERS_END -->\n";
      }catch{
        return "";
      }
    }

    function injectChapterBreaks(html){
      return html
        .replaceAll('<section class="chapter-cover">','<!--PAGEBREAK--><section class="chapter-cover">')
        .replaceAll('<section class="chapter-title">','<!--PAGEBREAK--><section class="chapter-title">');
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildMeasurer(){
      const innerVisible = isMobile() ? singlePage : leftPage;
      const pageVisible  = isMobile() ? pageS : pageL;

      const pageW = Math.max(320, Math.floor(pageVisible.getBoundingClientRect().width));
      const cs = getComputedStyle(innerVisible);

      const meas = document.createElement("div");
      meas.className = "inner";
      meas.style.width = pageW + "px";
      meas.style.padding = cs.padding;
      meas.style.fontFamily = cs.fontFamily;
      meas.style.fontSize = cs.fontSize;
      meas.style.lineHeight = cs.lineHeight;
      meas.style.letterSpacing = cs.letterSpacing;

      measureHost.innerHTML = "";
      measureHost.appendChild(meas);
      return { meas, pageVisible };
    }

    // ‚úÖ FIX: measure against full page inner height (padding included),
    // so we don't subtract padding twice (this is what caused overflow / missing words).
    function getMaxMeasureHeight(pageEl){
      const h = Math.max(240, pageEl.getBoundingClientRect().height);
      return Math.max(180, Math.floor(h - 2)); // 2px safety
    }

    function paginate(html){
      const src = injectChapterBreaks(html);
      const container = document.createElement("div");
      container.innerHTML = src;

      const blocks = Array.from(container.childNodes).filter(n => {
        if(n.nodeType === 3) return n.textContent.trim().length;
        if(n.nodeType === 1) return true;
        if(n.nodeType === 8) return true;
        return false;
      });

      const { meas, pageVisible } = buildMeasurer();
      const maxH = getMaxMeasureHeight(pageVisible);

      const pages = [];
      let pageHTML = "";

      function fits(testHTML){
        meas.innerHTML = testHTML;
        return meas.scrollHeight <= maxH;
      }

      function pushPage(){
        const trimmed = pageHTML.trim();
        if(trimmed.length){
          pages.push(trimmed);
          pageHTML = "";
        }
      }

      function splitParagraphNode(pNode){
        const cls = pNode.getAttribute("class");
        const text = (pNode.textContent || "").trim();
        const words = text.split(/\s+/).filter(Boolean);

        let buf = "";
        const out = [];

        for(const w of words){
          const next = buf ? (buf + " " + w) : w;
          const part = `<p${cls?` class="${cls}"`:``}>${escapeHtml(next)}</p>`;
          if(fits(pageHTML + part)){
            buf = next;
          }else{
            if(buf){
              out.push(`<p${cls?` class="${cls}"`:``}>${escapeHtml(buf)}</p>`);
              buf = w;
            }else{
              pushPage();
              buf = w;
            }
          }
        }

        if(buf){
          out.push(`<p${cls?` class="${cls}"`:``}>${escapeHtml(buf)}</p>`);
        }
        return out;
      }

      for(const node of blocks){
        if(node.nodeType === 8 && String(node.data||"").includes("PAGEBREAK")){
          pushPage();
          continue;
        }

        let nodeHTML = "";
        if(node.nodeType === 3){
          nodeHTML = `<p>${escapeHtml(node.textContent)}</p>`;
        }else if(node.nodeType === 1){
          nodeHTML = node.outerHTML || "";
        }else{
          continue;
        }

        if(fits(pageHTML + nodeHTML)){
          pageHTML += nodeHTML;
          continue;
        }

        if(pageHTML.length){
          pushPage();
          if(fits(pageHTML + nodeHTML)){
            pageHTML += nodeHTML;
            continue;
          }
        }

        if(node.nodeType === 1 && node.tagName === "P"){
          const parts = splitParagraphNode(node);
          for(const part of parts){
            if(fits(pageHTML + part)){
              pageHTML += part;
            }else{
              pushPage();
              pageHTML = part;
            }
          }
          continue;
        }

        pageHTML = nodeHTML;
        pushPage();
      }

      pushPage();
      return pages.filter(p => p.trim().length);
    }

    function normalizeIndex(){
      if(i < 0) i = 0;
      if(i > PAGES.length - 1) i = PAGES.length - 1;
      if(!isMobile() && i % 2 !== 0) i = Math.max(0, i - 1);
    }

    function updateCounters(){
      const total = String(PAGES.length || 0);
      pageTotalEl.textContent = total;
      mPageTotal.textContent = total;
      pageLabel.textContent = String(i+1);
      mPageLabel.textContent = String(i+1);
    }

    function saveProgressLocal(){
      localStorage.setItem(progressKeyLocal, String(i));
    }

    async function saveProgressAll(){
      saveProgressLocal();
      await saveCloudProgress();
    }

    // Achievements
    let __lastAchIndex = -999;

    function render(){
      if(PAGES.length === 0){
        if(isMobile()){
          singlePage.innerHTML = "<p class='muted'>No content yet.</p>";
        }else{
          leftPage.innerHTML = "<p class='muted'>No content yet.</p>";
          rightPage.innerHTML = "";
        }
        updateCounters();
        return;
      }

      normalizeIndex();
      updateCounters();

      if(isMobile()){
        singlePage.innerHTML = PAGES[i] || "<p class='muted'>End.</p>";
        singleNum.textContent = String(i+1);
      }else{
        const leftIdx = i;
        const rightIdx = i+1;
        leftPage.innerHTML = PAGES[leftIdx] || "<p class='muted'>End.</p>";
        rightPage.innerHTML = PAGES[rightIdx] || "<p class='muted'>End.</p>";
        leftNum.textContent = String(leftIdx+1);
        rightNum.textContent = (rightIdx+1 <= PAGES.length) ? String(rightIdx+1) : "";
      }

      saveProgressAll().catch(()=>{});

      if(__lastAchIndex !== i){
        __lastAchIndex = i;
        trackAchievements({ bookId, pageIndex: i, totalPages: PAGES.length }).catch(()=>{});
      }
    }

    function animateFlip(nextIndex){
      if(nextIndex < 0 || nextIndex > PAGES.length-1) return;

      const forward = nextIndex > i;

      flip.className = "flip";
      void flip.offsetWidth;

      if(isMobile()){
        flip.classList.add("full");
        if(forward){ flip.classList.add("fromRight","animForward"); }
        else{ flip.classList.add("fromLeft","animBackward"); }

        flipFront.innerHTML = PAGES[i] || "";
        flipBack.innerHTML  = PAGES[nextIndex] || "";
      }else{
        if(forward){
          flip.classList.add("fromRight","animForward");
          flipFront.innerHTML = PAGES[i+1] || "<p class='muted'>End.</p>";
          flipBack.innerHTML  = PAGES[nextIndex+1] || "<p class='muted'>End.</p>";
        }else{
          flip.classList.add("fromLeft","animBackward");
          flipFront.innerHTML = PAGES[i] || "<p class='muted'>Start.</p>";
          flipBack.innerHTML  = PAGES[nextIndex] || "<p class='muted'>Start.</p>";
        }
      }

      setTimeout(()=>{
        i = nextIndex;
        render();
        flip.className = "flip";
      }, 560);
    }

    function next(){
      if(isMobile()){
        if(i+1 <= PAGES.length-1) animateFlip(i+1);
      }else{
        if(i+2 <= PAGES.length-1) animateFlip(i+2);
      }
    }

    function prev(){
      if(isMobile()){
        if(i-1 >= 0) animateFlip(i-1);
      }else{
        if(i-2 >= 0) animateFlip(i-2);
      }
    }

    document.getElementById("nextBtn").addEventListener("click", next);
    document.getElementById("prevBtn").addEventListener("click", prev);
    document.getElementById("mNext").addEventListener("click", next);
    document.getElementById("mPrev").addEventListener("click", prev);

    document.addEventListener("keydown",(e)=>{
      if(e.key==="ArrowRight") next();
      if(e.key==="ArrowLeft") prev();
    });

    document.getElementById("bookTap").addEventListener("click",(e)=>{
      if(!isMobile()) return;
      const rect = e.currentTarget.getBoundingClientRect();
      const x = e.clientX - rect.left;
      if(x < rect.width * 0.42) prev();
      else if(x > rect.width * 0.58) next();
    });

    let sx=0, sy=0, st=0;
    document.getElementById("bookTap").addEventListener("touchstart",(e)=>{
      if(!isMobile()) return;
      const t = e.touches[0];
      sx = t.clientX; sy = t.clientY; st = Date.now();
    }, {passive:true});

    document.getElementById("bookTap").addEventListener("touchend",(e)=>{
      if(!isMobile()) return;
      const t = e.changedTouches[0];
      const dx = t.clientX - sx;
      const dy = t.clientY - sy;
      const dt = Date.now() - st;
      if(Math.abs(dx) > 45 && Math.abs(dy) < 70 && dt < 700){
        if(dx < 0) next();
        else prev();
      }
    }, {passive:true});

    function paginateAndRender(forceReflow=false){
      if(forceReflow){ void document.body.offsetHeight; }
      PAGES = paginate(BOOK_HTML);
      render();
    }

    // COMMUNITY MODAL WIRING
    const communityModal = document.getElementById("communityModal");
    const communityBtn = document.getElementById("communityBtn");
    const communityClose = document.getElementById("communityClose");
    const tabBtns = Array.from(document.querySelectorAll(".tabBtn"));
    const panels = {
      commentsTab: document.getElementById("commentsTab"),
      ratingTab: document.getElementById("ratingTab"),
      achTab: document.getElementById("achTab"),
      guideTab: document.getElementById("guideTab")
    };

    async function openCommunity({ scrollToCommentId = "" } = {}){
      communityModal.classList.add("show");
      communityModal.setAttribute("aria-hidden","false");
      lockScroll();

      document.getElementById("guideMount").innerHTML = guidelinesHTML();

      await renderComments({ bookId, mountId:"commentsList", max: 60 });

      renderRatingSummary({ bookId, mountId:"ratingSummary" }).catch(()=>{});
      renderMyAchievements({ bookId, mountId:"achList" }).catch(()=>{});

      loadMyRating({ bookId }).then(r=>{
        const sel = document.getElementById("myRatingSel");
        if(sel) sel.value = String(r || 0);
      }).catch(()=>{});

      if(scrollToCommentId){
        setTab("commentsTab");
        const el = document.getElementById(`c_${scrollToCommentId}}`);
        if(el){
          el.scrollIntoView({ behavior:"smooth", block:"start" });
        }
      }
    }

    function closeCommunity(){
      communityModal.classList.remove("show");
      communityModal.setAttribute("aria-hidden","true");
      unlockScroll();
    }

    communityBtn.addEventListener("click", ()=>openCommunity());
    communityClose.addEventListener("click", closeCommunity);
    communityModal.addEventListener("click",(e)=>{ if(e.target === communityModal) closeCommunity(); });

    document.getElementById("mCommunity").addEventListener("click", ()=>openCommunity());

    function setTab(id){
      tabBtns.forEach(b=> b.classList.toggle("active", b.getAttribute("data-tab") === id));
      Object.keys(panels).forEach(k=> panels[k].classList.toggle("show", k === id));

      if(id === "commentsTab") renderComments({ bookId, mountId:"commentsList", max: 60 }).catch(()=>{});
      if(id === "ratingTab") renderRatingSummary({ bookId, mountId:"ratingSummary" }).catch(()=>{});
      if(id === "achTab") renderMyAchievements({ bookId, mountId:"achList" }).catch(()=>{});
      if(id === "guideTab") document.getElementById("guideMount").innerHTML = guidelinesHTML();
    }

    tabBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-tab");
        setTab(id);
      });
    });

    setupCommentForm({
      bookId,
      formId:"commentForm",
      nameId:"cName",
      textId:"cText",
      ratingId:"cRating",
      msgId:"cMsg",
      afterPostReload:true,
      mountId:"commentsList"
    });

    document.getElementById("saveMyRating").addEventListener("click", async ()=>{
      const msg = document.getElementById("ratingMsg");
      if(msg) msg.textContent = "";
      const sel = document.getElementById("myRatingSel");
      const r = Number(sel?.value || 0);
      try{
        await submitRating({ bookId, rating: r });
        if(msg) msg.textContent = "Saved ‚úÖ";
        await renderRatingSummary({ bookId, mountId:"ratingSummary" });
      }catch(e){
        if(msg) msg.textContent = (e?.message || "Please sign in to rate.");
      }
    });

    (async ()=>{
      try{
        await loadBook();
        const cloud = await loadChaptersFromCloud();
        if(cloud && cloud.trim().length){
          BOOK_HTML = BOOK_HTML + "\n\n" + cloud;
        }
      }catch(e){
        BOOK_HTML = `<p class="muted">${escapeHtml(String(e))}</p>`;
      }

      requestAnimationFrame(()=>requestAnimationFrame(()=> paginateAndRender(true)));

      let t=null;
      window.addEventListener("resize", ()=>{
        clearTimeout(t);
        t=setTimeout(()=>paginateAndRender(true), 160);
      });

      // Deep link support:
      if(deepOpen === "community"){
        setTimeout(()=>{
          openCommunity({ scrollToCommentId: deepCommentId || "" }).catch(()=>{});
        }, 200);
      }
    })();
  </script>
</body>
</html>
